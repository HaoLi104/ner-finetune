#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ä½¿ç”¨ Elasticsearch å¯¹ Excel.cleaned_text åšå…³é”®è¯åˆ†ç±»æ£€ç´¢
å¹¶è¾“å‡º {ä¸­æ–‡åˆ†ç±»å: [id1, id2, ...]} åˆ° JSON

è¿è¡Œ:
    python es_classify_to_json.py
ä¾èµ–:
    pip install elasticsearch pandas openpyxl tqdm
"""

from pathlib import Path
import sys
import json
from typing import List, Dict
from tqdm import tqdm

import pandas as pd
from elasticsearch import Elasticsearch, helpers

# ===========================================================================
# 1. å›ºå®šå‚æ•°
# ===========================================================================
EXCEL_FILE = r"breast_cancer.xlsx"  # Excel è·¯å¾„
ID_COL = "id"  # Excel ä¸­å”¯ä¸€æ ‡è¯†åˆ—ï¼›è‹¥æ— åˆ™è®¾ä¸º None
ES_HOST = "http://192.168.19.211:9200"  # Elasticsearch åœ°å€ 4090 dockerå¯åŠ¨
ES_USERNAME = None  # å¦‚éœ€è®¤è¯ï¼Œå¡«ç”¨æˆ·å
ES_PASSWORD = None  # å¦‚éœ€è®¤è¯ï¼Œå¡«å¯†ç 
INDEX_NAME = "breast_cancer_fullcontent"  # ç´¢å¼•åç§°
OUTPUT_JSON = "category_id_map.json"  # ç»“æœæ–‡ä»¶

# ===========================================================================
# 2. ä¸­æ–‡åˆ†ç±»å â†’ å…³é”®è¯åˆ—è¡¨
# ===========================================================================
category_keywords: Dict[str, List[str]] = {
    # TODO æ£€æŸ¥å†…åˆ†æ³Œè®°å½•çš„æ£€ç´¢è¯ï¼Œæ§åˆ¶åœ¨é«˜ç›¸å…³æ€§ï¼Œ0802ä¸‹åˆå¯¼å…¥æ ‡æ³¨ç³»ç»Ÿ
    "å†…åˆ†æ³Œè®°å½•": [
        "å†…åˆ†æ³Œ",
        "æ¿€ç´ æ²»ç–—",
        "ä»–è«æ˜”èŠ¬",
        "TAM",
        "æ‰˜ç‘ç±³èŠ¬",
        "æ¥æ›²å”‘",
        "é˜¿é‚£æ›²å”‘",
        "ä¾è¥¿ç¾å¦",
        "èŠ³é¦™åŒ–é…¶æŠ‘åˆ¶å‰‚",
        "AI",
        "æ°Ÿç»´å¸ç¾¤",
        "Faslodex",
        "é€‰æ‹©æ€§é›Œæ¿€ç´ å—ä½“é™è§£å‰‚ï¼ˆSERDï¼‰",
        "äº®ä¸™ç‘æ—",
        "å¢æ™®ç‘æ—",
        "æˆˆèˆç‘æ—",
        "ä¿ƒæ€§è…ºæ¿€ç´ é‡Šæ”¾æ¿€ç´ æ¿€åŠ¨å‰‚ï¼ˆGnRH-aï¼‰",
        "é˜¿åŸ¹åˆ©å¸",
        "ç‘æ³¢è¥¿åˆ©",
        "å¸•åšè¥¿å°¼",
        "é˜¿è´è¥¿åˆ©",
        "è¾¾é²èˆèƒº",
        "åµå·¢æŠ‘åˆ¶",
        "åµå·¢å»åŠ¿",
        "åµå·¢åŠŸèƒ½æŠ‘åˆ¶ï¼ˆOFSï¼‰",
        "åµå·¢åˆ‡é™¤",
        "ç»ç»å‰å†…åˆ†æ³Œæ²»ç–—",
        "ç»ç»åå†…åˆ†æ³Œæ²»ç–—",
        "è¾…åŠ©å†…åˆ†æ³Œæ²»ç–—",
        "æ–°è¾…åŠ©å†…åˆ†æ³Œæ²»ç–—",
        "æŠ—é›Œæ¿€ç´ ",
        "SERM",
        "é›·æ´›æ˜”èŠ¬",
        "Raloxifene",
        "Anastrozole",
        "Letrozole",
        "Exemestane",
        "Aromasin",
        "Fulvestrant",
        "å†…åˆ†æ³Œè€è¯",
    ],
    "æ‰‹æœ¯è®°å½•": [
        # â€”â€” æ ¸å¿ƒæœ¯è¯­
        # "ã€æ‰‹æœ¯ã€‘",
        "åˆ‡é™¤æœ¯",
        "æ ¹æ²»æ‰‹æœ¯",
        "ä¹³è…ºç™Œæ ¹æ²»æœ¯",
        "ä¿ä¹³æ‰‹æœ¯",
        "ä¹³æˆ¿åˆ‡é™¤æœ¯",
        # â€”â€” æœ¯å¼æè¿°
        "æ”¹è‰¯æ ¹æ²»æœ¯",
        "ç»å…¸æ ¹æ²»æœ¯",
        "æ‰©å¤§æ ¹æ²»æœ¯",
        "å•çº¯åˆ‡é™¤æœ¯",
        "ä¿ä¹³åˆ‡é™¤æœ¯",
        "å§‘æ¯æ€§æ‰‹æœ¯",
        "è¾…åŠ©æ€§æ‰‹æœ¯",
        # â€”â€” æ‰‹æœ¯åç§° / åŠ¨ä½œåŠ¨è¯ç»„åˆ
        "ä¹³æˆ¿åˆ‡é™¤",
        "è‚¿å—åˆ‡é™¤",
        "ä¹³è…ºè‚¿å—æ‰‹æœ¯",
        "è…‹çªæ¸…æ‰«",
        "æ·‹å·´ç»“æ¸…æ‰«",
        "å‰å“¨æ·‹å·´ç»“æ´»æ£€",
        "å‰å“¨æ·‹å·´æ´»æ£€",
        "ä¹³æˆ¿é‡å»ºæœ¯",
        "åµå·¢åˆ‡é™¤æœ¯",
        # â€”â€” å¸¸ç”¨æ­é…è¡¨è¾¾ï¼ˆæ›´æ¥è¿‘æ—¥å¸¸ç—…å†å†™æ³•ï¼‰
        "è¡Œä¹³è…ºæ‰‹æœ¯",
        "æ¥å—æ ¹æ²»æœ¯",
        "æ‹Ÿè¡Œä¿ä¹³æœ¯",
        "å®Œæˆæ‰‹æœ¯åˆ‡é™¤",
        "æ‰‹æœ¯æ–¹å¼ä¸º",
        "å®æ–½è…‹çªæ¸…æ‰«",
        # â€”â€” éƒ¨ä½ä¿¡æ¯
        "å·¦ä¹³æ‰‹æœ¯",
        "å³ä¹³æ‰‹æœ¯",
        "åŒä¾§ä¹³è…ºæ‰‹æœ¯",
        "åŒä¹³åˆ‡é™¤",
        "å±€éƒ¨ç—…ç¶åˆ‡é™¤",
        "å·¦ä¹³åˆ‡é™¤",
        "å³ä¹³è‚¿å—åˆ‡é™¤",
        # â€”â€” æ·‹å·´ç»“å¤„ç†
        "Iç»„æ·‹å·´ç»“æ¸…æ‰«",
        "IIç»„æ·‹å·´ç»“æ¸…æ‰«",
        "IIIç»„æ·‹å·´ç»“æ¸…æ‰«",
        "å†…ä¹³æ·‹å·´ç»“æ¸…æ‰«",
        "é”éª¨ä¸Šæ·‹å·´ç»“æ¸…æ‰«",
        "è…‹çªæ·‹å·´ç»“æ¸…æ‰«",
        "å‰å“¨æ·‹å·´ç»“å®šä½",
    ],
    "åŒ–ç–—è®°å½•": [
        "åŒ–ç–—",
        "åŒ–ç–—æ–¹æ¡ˆ",
        "åŒ–ç–—è¯ç‰©",
        "é˜¿éœ‰ç´ ",
        "å¤šè¥¿ä»–èµ›",
        "ç´«æ‰é†‡",
        "é•¿æ˜¥ç‘æ»¨",
        "å¡åŸ¹ä»–æ»¨",
        "ç¯ç£·é…°èƒº",
        "è¡¨æŸ”æ¯”æ˜Ÿ",
        "é¡ºé“‚",
        "å¥¥æ²™åˆ©é“‚",
        "å‰è¥¿ä»–æ»¨",
        "æ°Ÿå°¿å˜§å•¶",
        "ä¼Šç«‹æ›¿åº·",
        "ç´«æ‰é†‡è„‚è´¨ä½“",
        "å¥ˆè¾¾é“‚",
        "ä¼Šè¾¾æ¯”æ˜Ÿ",
        "ä¾æ‰˜æ³Šè‹·",
        "å‰ä¸‰ä»£",
        "å‰è¥¿ä»–æ»¨è„‚è´¨ä½“",
        "é•¿æ˜¥åœ°è¾›",
        "ç´«æ‰é†‡èƒ¶æŸ",
        "ä¼Šé©¬æ›¿å°¼" "ACæ–¹æ¡ˆ",
        "AC-Tæ–¹æ¡ˆ",
        "TCæ–¹æ¡ˆ",
        "TACæ–¹æ¡ˆ",
        "TECæ–¹æ¡ˆ",
        "FECæ–¹æ¡ˆ",
        "EC-Tæ–¹æ¡ˆ",
        "CMFæ–¹æ¡ˆ",
        "CEFæ–¹æ¡ˆ",
        "FACæ–¹æ¡ˆ",
        "TCbHæ–¹æ¡ˆ",
        "TCHæ–¹æ¡ˆ",
        "AC-THæ–¹æ¡ˆ",
        "ddAC-Tï¼ˆå‰‚é‡å¯†é›†å‹ï¼‰",
        "Dose-dense TAC",
        "Dose-dense AC-T",
        "å•è¯ç´«æ‰é†‡æ–¹æ¡ˆ",
        "å¡åŸ¹ä»–æ»¨å•è¯æ–¹æ¡ˆ" "å•å‘¨æ–¹æ¡ˆ",
        "åŒå‘¨æ–¹æ¡ˆ",
        "ä¸‰å‘¨æ–¹æ¡ˆ",
        "å››å‘¨æ–¹æ¡ˆ",
        "21å¤©ä¸€å‘¨æœŸ",
        "14å¤©ä¸€å‘¨æœŸ",
        "7å¤©ä¸€å‘¨æœŸ",
        "28å¤©ä¸€å‘¨æœŸ",
    ],
    "å…ç–«æ²»ç–—": [
        "å…ç–«",
        "å…ç–«æ²»ç–—",
        "å…ç–«æ£€æŸ¥ç‚¹",
        "PD-1",
        "PD-L1",
        "å…ç–«ç›¸å…³ä¸è‰¯ååº”",
        "å…ç–«ç»´æŒæ²»ç–—",
        "å…ç–«è”åˆæ²»ç–—",
        "å…ç–«å•è¯æ²»ç–—",
        "å¸•åšåˆ©ç å•æŠ—",
        "çº³æ­¦åˆ©å°¤å•æŠ—",
        "é˜¿æ›¿åˆ©ç å•æŠ—",
        "åº¦ä¼åˆ©å°¤å•æŠ—",
        "ç‰¹ç‘æ™®åˆ©å•æŠ—",
        "ä¿¡è¿ªåˆ©å•æŠ—",
        "å¡ç‘åˆ©ç å•æŠ—",
        "å…ç–«æ£€æŸ¥ç‚¹æŠ‘åˆ¶å‰‚",
        "PD-1æŠ‘åˆ¶å‰‚",
        "PD-L1æŠ‘åˆ¶å‰‚",
        "å…ç–«è”åˆåŒ–ç–—",
        "å…ç–«è”åˆé¶å‘æ²»ç–—",
        "å…ç–«è”åˆæŠ—HER2æ²»ç–—",
        "å…ç–«è”åˆæ”¾ç–—",
        "å…ç–«ç»´æŒæ–¹æ¡ˆ",
        "å…ç–«åºè´¯åŒ–ç–—",
        "å…ç–«æ–°è¾…åŠ©æ²»ç–—",
        "å…ç–«è¾…åŠ©æ²»ç–—",
        "PD-1è”åˆç´«æ‰é†‡",
        "PD-L1è”åˆç™½è›‹ç™½ç´«æ‰é†‡",
        "å…ç–«è”åˆCDK4/6æŠ‘åˆ¶å‰‚",
    ],
    "æ”¾ç–—è®°å½•": [
        "æ”¾ç–—",
        "æ”¾å°„æ²»ç–—",
        "æ¥å—æ”¾ç–—",
        "è¿›è¡Œæ”¾ç–—",
        "æ‹Ÿè¡Œæ”¾ç–—",
        "æ”¾ç–—ä¸­",
        "æ”¾ç–—å",
        "è°ƒå¼ºæ”¾ç–—",
        "ä¸‰ç»´é€‚å½¢æ”¾ç–—",
        "ç«‹ä½“å®šå‘æ”¾å°„æ²»ç–—",
        "å¸¸è§„æ”¾ç–—",
        "é€‚å½¢è°ƒå¼ºæ”¾ç–—",
        "IMRT",
        "SRT",
        "IGRT",
        "VMAT",
        "æ”¾ç–—è®¡åˆ’",
        "æ”¾ç–—æ–¹æ¡ˆ",
        "åˆ¶å®šæ”¾ç–—è®¡åˆ’",
        "å¼€å§‹æ”¾ç–—",
        "æ”¾ç–—å‘¨æœŸ",
        "æ”¾ç–—åˆ†æ¬¡",
        "æ”¾ç–—å‰‚é‡",
        "åˆ†å‰²æ¬¡æ•°",
        "æ€»å‰‚é‡",
        "å‰‚é‡åˆ†å‰²",
        "æ¯æ—¥å‰‚é‡",
        "ç´¯è®¡å‰‚é‡",
        "èƒ¸å£ç…§å°„",
        "é”éª¨ä¸Šç…§å°„",
        "è…‹çªç…§å°„",
        "ä¹³è…ºåºŠç…§å°„",
        "è‚¿ç˜¤åºŠç…§å°„",
        "é¶åŒºç…§å°„",
        "æ·‹å·´å¼•æµåŒºç…§å°„",
        "å†…ä¹³åŒºç…§å°„",
        "æ”¾ç–—å‰¯ä½œç”¨",
        "æ”¾ç–—ååº”",
        "æ”¾ç–—å¹¶å‘ç—‡",
        "çš®è‚¤çº¢æ–‘",
        "çš®è‚¤è„±å±‘",
        "ç…§å°„åŒºåŸŸç–¼ç—›",
        "ç…§å°„é‡",
        "æ”¾ç–—é‡",
        "åŠ é€Ÿå™¨ç…§å°„",
        "ç”µå­çº¿ç…§å°„",
    ],
    "é¶å‘æ²»ç–—": [
        "é¶å‘",
        "é¶å‘æ²»ç–—",
        "HER2é¶å‘",
        "æ›²å¦¥ç å•æŠ—",
        "Trastuzumab",
        "å¸•å¦¥ç å•æŠ—",
        "Pertuzumab",
        "æ‹‰å¸•æ›¿å°¼",
        "Lapatinib",
        "å¥ˆæ‹‰æ›¿å°¼",
        "Neratinib",
        "å¡å’¯æ›¿å°¼",
        "Pyrotinib",
        "T-DM1",
        "æ›²å¦¥ç å•æŠ—-è‰¾å§†å¦æ–°å¶è”ç‰©",
        "Kadcyla",
        "Enhertu",
        "DS-8201",
        "æ›²å¦¥ç å•æŠ—å¾·é²æ›¿åº·",
        "æŠ—HER2æ²»ç–—",
        "HER2æŠ—ä½“å¶è”è¯ç‰©",
        "HER2-TKI",
        "åŒé¶å‘æ²»ç–—",
        "æŠ—HER2è”åˆåŒ–ç–—",
        "æŠ—HER2è¾…åŠ©æ²»ç–—",
        "æŠ—HER2æ–°è¾…åŠ©æ²»ç–—",
        "HER2ç»´æŒæ²»ç–—",
    ],
    "è¾…åŠ©æ²»ç–—": [
        "è¾…åŠ©æ²»ç–—",
        "éª¨ä¿æŠ¤",
        "åŒè†¦é…¸ç›",
        "åœ°è¯ºå•æŠ—",
        "å”‘æ¥è†¦é…¸",
        "é˜¿ä»‘è†¦é…¸é’ ",
        "å¸•ç±³è†¦é…¸äºŒé’ ",
        "ä¼Šå¸ƒè†¦é…¸",
        "é›·è†¦é…¸",
        "äºŒè†¦é…¸ç›",
        "éª¨è´¨ç–æ¾",
        "éª¨å¯†åº¦",
        "éª¨è½¬æ¢æ ‡å¿—ç‰©",
        "éª¨å¸æ”¶æŠ‘åˆ¶",
    ],
    # ---------------- ä»¥ä¸‹ä¸ºç»†åˆ†åˆ†ç±» ----------------
    "ç—…ç†æŠ¥å‘Š_æ´»æ£€ç—…ç†": [
        "æ´»æ£€",
        "ç©¿åˆºæ´»æ£€",
        "åˆ‡å–æ´»æ£€",
        "åˆ‡é™¤æ´»æ£€",
        "å–æ ·æ–¹å¼",
        "åŸå‘ç¶å–æ ·",
        "è½¬ç§»ç¶å–æ ·",
        "å‰å“¨æ·‹å·´ç»“å–æ ·",
        "è…‹çªæ·‹å·´ç»“å–æ ·",
        "é”éª¨æ·‹å·´ç»“å–æ ·",
        "ç»„ç»‡å­¦åˆ†ç±»",
        "åŸä½ç™Œ",
        "æµ¸æ¶¦æ€§å¯¼ç®¡ç™Œ",
        "æµ¸æ¶¦æ€§å°å¶ç™Œ",
        "å…¶ä»–ç»„ç»‡å­¦ç±»å‹",
        "ç»„ç»‡å­¦åˆ†çº§",
        "Içº§ï¼ˆé«˜åˆ†åŒ–ï¼‰",
        "IIçº§ï¼ˆä¸­åˆ†åŒ–ï¼‰",
        "IIIçº§ï¼ˆä½åˆ†åŒ–ï¼‰",
        "é€æ£€æ·‹å·´ç»“ä¸ªæ•°",
        "é˜³æ€§æ·‹å·´ç»“ä¸ªæ•°",
    ],
    "ç—…ç†æŠ¥å‘Š_æœ¯åç—…ç†": [
        "æœ¯åç—…ç†",
        "æ‰‹æœ¯ç—…ç†",
        "åˆ‡é™¤ç—…ç†",
        "åˆ‡é™¤æ ‡æœ¬",
        "æœ¯ååˆ‡ç¼˜",
        "åˆ‡ç¼˜æƒ…å†µ",
        "åˆ‡ç¼˜é˜³æ€§",
        "åˆ‡ç¼˜é˜´æ€§",
        "åˆ‡ç¼˜è·è‚¿ç˜¤æœ€è¿‘å¤„è·ç¦»",
        "ç¥ç»æµ¸æ¶¦",
        "è„‰ç®¡æµ¸æ¶¦",
        "Miller&Payne",
        "Millerâ€“Payne",
        "MPåˆ†çº§",
        "MPè¯„åˆ†",
        "MP 1çº§",
        "MP 2çº§",
        "MP 3çº§",
        "MP 4çº§",
        "MP 5çº§",
        "MP-G1",
        "MP-G2",
        "MP-G3",
        "MP-G4",
        "MP-G5",
        "ç—…ç¶å¤§å°",
        "è‚¿ç˜¤æ®‹ä½™",
        "æ®‹ä½™æµ¸æ¶¦æ€§ç™Œ",
        "æ®‹ä½™åŸä½ç™Œ",
        "æ®‹ä½™è‚¿ç˜¤æ€§è´¨",
        "æ®‹ä½™è‚¿ç˜¤éƒ¨ä½",
        "æœ‰æ— åˆå¹¶åŸä½ç™Œ",
        "é€æ£€æ·‹å·´ç»“ä¸ªæ•°",
        "é˜³æ€§æ·‹å·´ç»“ä¸ªæ•°",
        "ç—…ç†åˆ†æœŸ",
        "pT1N0M0",
        "T1N0M0",
        "pT1",
        "pT2N1M0",
        "T1N1M0",
        "pT2",
        "T2N2M0",
        "pT3N2M1",
        "T3N2M1",
        "pT3",
        "pT4N3M0",
        "T4N3M0",
        "pTisN0M0",
        "TisN0M0",
        "pT1N1M0",
        "T1N1M0",
        "pT2N2M0",
        "T2N2M0",
        "pT4N1M1",
        "T4N1M1",
        "ç—…ç†åˆ†æœŸä¸ºpT2N1M0",
        "æœ¯åç—…ç†åˆ†æœŸpT1N0M0",
        "æœ¯åpT2N1M0",
        "æœ¯ååˆ†æœŸpT3N2M1",
        "ç—…ç†TNMåˆ†æœŸpT2N1M0" "Tis(DCIS)",
        "Tis(Paget)",
        "ç»„ç»‡å­¦åˆ†çº§",
        "Içº§ï¼ˆé«˜åˆ†åŒ–ï¼‰",
        "IIçº§ï¼ˆä¸­åˆ†åŒ–ï¼‰",
        "IIIçº§ï¼ˆä½åˆ†åŒ–ï¼‰",
        "ç»„ç»‡å­¦åˆ†ç±»",
        "åŸä½ç™Œï¼ˆæœ¯åï¼‰",
        "æµ¸æ¶¦æ€§å¯¼ç®¡ç™Œï¼ˆæœ¯åï¼‰",
        "æµ¸æ¶¦æ€§å°å¶ç™Œï¼ˆæœ¯åï¼‰",
        "æœ¯å‰æ–°è¾…åŠ©æ²»ç–—",
    ],
    "ç—…ç†æŠ¥å‘Š_åˆ†å­ç—…ç†": [
        # ER è¡¨è¾¾
        "ER(+)",
        "ER(2+)",
        "ER(3+)",
        "ER(-)",
        "ERè¡¨è¾¾",
        "ER(%)",
        # PR è¡¨è¾¾
        "PR(+)",
        "PR(2+)",
        "PR(3+)",
        "PR(-)",
        "PRè¡¨è¾¾",
        "PR(%)",
        # HER2 è¡¨è¾¾
        "HER2(+)",
        "HER2(2+)",
        "HER2(3+)",
        "HER2(-)",
        "HER2å…ç–«ç»„åŒ–",
        "HER2 IHC(2+)",
        "HER2 IHC(3+)",
        # FISH
        "FISHæ‰©å¢",
        "FISHæœªæ‰©å¢",
        "FISH(+)",
        "FISH(-)",
        "FISHæ¯”å€¼",
        # Ki-67
        "Ki-67(%)",
        "Ki-67(+)",
        "Ki-67é«˜è¡¨è¾¾",
        "Ki-67ä¸º",
        # PIK3CA
        "PIK3CA(+)",
        "PIK3CA(-)",
        "PIK3CAçªå˜",
        # é™å®šéƒ¨ä½
        "åŸå‘ç¶IHC",
        "æ·‹å·´ç»“IHC",
        "è½¬ç§»ç¶IHC",
    ],
    "ç—…ç†æŠ¥å‘Š_åŸºå› æ£€æµ‹": [
        # æ ¸å¿ƒæœ¯è¯­
        # "åŸºå› æ£€æµ‹",
        "NGS",
        "NGSæ£€æµ‹",
        "NGSæµ‹åº",
        "21åŸºå› ",
        # CTC
        "CTC",
        "CTCè®¡æ•°",
        "CTCé˜³æ€§",
        "CTCæ£€æµ‹",
        # BRCA
        "BRCA",
        "BRCAçªå˜",
        "BRCAé‡ç”Ÿå‹",
        "BRCA1çªå˜",
        "BRCA1",
        "BRCA1é‡ç”Ÿå‹",
        "BRCA2çªå˜",
        "BRCA2é‡ç”Ÿå‹",
        "BRCA2",
        # PD-L1
        "PD-L1",
        "PD-L1é˜³æ€§",
        "PD-L1é˜´æ€§",
        "PD-L1è¡¨è¾¾",
        "PD-L1æ£€æµ‹",
    ],
    "ç—…æƒ…è¯Šæ–­ä¸è¯„ä¼°_åˆè¯Š": [
        # â€”â€” æ˜ç¡®åˆè¯Šæ—¶é—´æˆ–çŠ¶æ€çš„è¡¨è¾¾
        "åˆè¯Š",
        "é¦–æ¬¡å°±è¯Š",
        "åˆæ¬¡å°±è¯Š",
        "åˆæ¬¡è¯Šæ–­",
        "åˆæ¬¡å‘ç°",
        "é¦–æ¬¡",
        "ä½“æ£€å‘ç°",
        "ä½“æ£€æ—¶å‘ç°",
        "ä¹³è…ºä½“æ£€å‘ç°",
        # â€”â€” ä¸»è¯‰æˆ–ç—‡çŠ¶ç›¸å…³
        "ä¹³è…ºåŒ…å—",
        "ä¹³å¤´æº¢æ¶²",
        "ä¹³å¤´å‡¹é™·",
        "ä¹³æˆ¿ç–¼ç—›",
        "ä¹³è…ºçš®è‚¤çº¢è‚¿",
        "è…‹çªåŒ…å—",
        "è…‹çªæ·‹å·´ç»“è‚¿å¤§",
        "ä¹³å¤´å†…é™·",
        "ä¹³å¤´ã€ä¹³æ™•å¼‚å¸¸",
        # â€”â€” å½±åƒæè¿°ï¼ˆMRIã€Bè¶…ã€é’¼é¶ï¼‰
        "å³ä¹³MRI",
        "å·¦ä¹³MRI",
        "å³ä¹³Bè¶…",
        "å·¦ä¹³Bè¶…",
        "å³ä¹³é’¼é¶",
        "å·¦ä¹³é’¼é¶",
        "è‚¿å—å¤§å°",
        # â€”â€” è½¬ç§»/åˆ‡é™¤å¯è¡Œæ€§åˆ¤æ–­
        "åŸå‘ç¶å¯åˆ‡é™¤",
        "åŸå‘ç¶ä¸å¯åˆ‡é™¤",
        # "è‚ºè½¬ç§»",
        # "è‚è½¬ç§»",
        # "éª¨è½¬ç§»",
        # "è„‘è½¬ç§»",
        "è½¬ç§»ç¶",
        # â€”â€” å±è±¡çŠ¶æ€
        "å†…è„å±è±¡",
        "å‡ºç°å±è±¡",
        "è„å™¨åŠŸèƒ½å¼‚å¸¸",
        "å±è±¡",
        # â€”â€” æ·‹å·´ç»“æè¿°ï¼ˆä»…é™åˆè¯Šï¼‰
        "è…‹çªæ·‹å·´ç»“è‚¿å¤§",
        "å†…ä¹³åŒºæ·‹å·´ç»“",
        "é”éª¨ä¸ŠåŒºæ·‹å·´ç»“",
        "é”éª¨ä¸‹åŒºæ·‹å·´ç»“",
        "æ·‹å·´ç»“å¯ç–‘",
        "æŸ¥ä½“é˜³æ€§",
        "æ·‹å·´ç»“å¤§å°",
        "æ·‹å·´ç»“å¯è§¦",
        # â€”â€” çš®è‚¤è¡¨ç° & é’™åŒ–
        "çš®è‚¤å—ä¾µ",
        "çš®è‚¤çº¢è‚¿",
        "æ©˜çš®æ ·æ”¹å˜",
        "çš®è‚¤æºƒç ´",
        "çš®è‚¤ç´§å¼ å‘äº®",
        "å¼¥æ¼«æ€§é’™åŒ–",
        "å¾®å°é’™åŒ–",
        "é’™åŒ–ç‚¹",
        "å¼¥æ¼«æ€§å¾®å°é’™åŒ–",
        # â€”â€” è‚¿å—ä½ç½®ï¼ˆè¾…åŠ©è¡¨è¾¾ï¼‰
        "å¤–ä¸Šè±¡é™",
        "å¤–ä¸‹è±¡é™",
        "å†…ä¸Šè±¡é™",
        "å†…ä¸‹è±¡é™",
        "ä¸­å¤®åŒº",
        "è·ä¹³å¤´è·ç¦»",
        "è‚¿å—è·ä¹³å¤´",
    ],
    "ç—…æƒ…è¯Šæ–­ä¸è¯„ä¼°_æ–°è¾…åŠ©æ²»ç–—ä¸­": [
        # â€”â€” é˜¶æ®µæ ‡è¯†ï¼ˆé™åˆ¶è¯­å¢ƒï¼Œä»…åŒ¹é…â€œæœ¯å‰é˜¶æ®µâ€ï¼‰
        "æ–°è¾…åŠ©æ²»ç–—",
        "æ–°è¾…åŠ©åŒ–ç–—",
        "æ–°è¾…åŠ©æ–¹æ¡ˆ",
        "æœ¯å‰æ²»ç–—",
        "æœ¯å‰åŒ–ç–—",
        "æœ¯å‰æ–¹æ¡ˆ",
        # â€”â€” ç–—æ•ˆè¯„ä¼°æ ‡å‡†è¡¨è¾¾ï¼ˆå¯¹åº”å­—æ®µâ€œç–—æ•ˆè¯„ä¼°â€ï¼‰
        "å®Œå…¨ç¼“è§£",
        "éƒ¨åˆ†ç¼“è§£",
        "ç—…æƒ…ç¨³å®š",
        "ç—…æƒ…æ¶åŒ–",
        "æ— æ³•è¯„ä»·",
        "æ— ç–¾ç—…çŠ¶æ€",
        "CR",
        "PR",
        "SD",
        "PD",
        "NE",
        "NED",
        "è€ƒè™‘è¿›å±•",
        "è€ƒè™‘ç¼“è§£",
        "è€ƒè™‘ç¨³å®š",
        "åŸºçº¿è¯„ä¼°",
        # â€”â€” ç–—æ•ˆè‡ªç„¶è¯­è¨€è¡¨è¾¾ï¼ˆæ¨¡ç³Šã€éæ ‡å‡†æœ¯è¯­ï¼‰
        "è‚¿å—ç¼©å°",
        "ç—…ç¶ç¼©å°",
        "ç—…ç¶æ˜æ˜¾ç¼©å°",
        "ç—…ç¶è¾ƒå‰ç¼©å°",
        "ç—…ç¶æ¶ˆé€€",
        "å½±åƒç¼“è§£",
        "è½¬ç§»ç¶å‡å°‘",
        "ç—…ç¶è¿›å±•",
        "ç—…ç¶æ‰©å¤§",
        "å½±åƒæ˜¾ç¤ºç—…æƒ…åŠ é‡",
        # â€”â€” è½¬ç§»ç›¸å…³ï¼ˆæ–°å¢è½¬ç§»è¯†åˆ« + è¯­ä¹‰æ‰©å±•ï¼‰
        "æ–°å‘è½¬ç§»",
        "æ–°å‘è‚ºè½¬ç§»",
        "æ–°å‘è‚è½¬ç§»",
        "æ–°å‘éª¨è½¬ç§»",
        "æ–°å‘è„‘è½¬ç§»",
        "è‚ºéƒ¨è½¬ç§»åŠ é‡",
        "è‚è½¬ç§»è¿›å±•",
        "éª¨è½¬ç§»è¿›å±•",
        "è„‘è½¬ç§»è¿›å±•",
        # â€”â€” å±è±¡çŠ¶æ€ï¼ˆç”¨äºè¾…åŠ©åˆ¤æ–­é¢„åä¸æ²»ç–—ç´§è¿«åº¦ï¼‰
        "å†…è„å±è±¡",
        "å†…è„åŠŸèƒ½è¡°ç«­",
        "åŠŸèƒ½å—æŸ",
        "å™¨å®˜åŠŸèƒ½å¼‚å¸¸",
        "ä¸´åºŠå±è±¡",
        # â€”â€” ç–—æ•ˆè¯„ä¼°æ–¹å¼ï¼ˆç”¨äºæ˜ç¡®è¯„ä¼°æ–¹å¼å­—æ®µï¼‰
        "Bè¶…å¤æŸ¥",
        "MRIè¯„ä¼°",
        "MRIå¤æŸ¥",
        "Bè¶…æç¤º",
        "MRIæç¤º",
        "æŸ¥ä½“æç¤ºè¿›å±•",
        "æŸ¥ä½“æç¤ºç¼“è§£",
        "æŸ¥ä½“æç¤ºç¨³å®š",
    ],
    "ç—…æƒ…è¯Šæ–­ä¸è¯„ä¼°_å¤å‘ç¡®è¯Š": [
        # â€”â€” å¤å‘é˜¶æ®µæ ‡è¯†
        "å¤å‘",
        "å¤å‘ç¡®è¯Š",
        "å†æ¬¡å‡ºç°ç—…ç¶",
        "è‚¿ç˜¤å¤å‘",
        # â€”â€” å±€éƒ¨å¤å‘ä½ç½®
        "èƒ¸å£å¤å‘",
        "åŒºåŸŸæ·‹å·´ç»“å¤å‘",
        "é”éª¨ä¸Šå¤å‘",
        "ä¹³è…ºå¤å‘",
        "å±€éƒ¨å¤å‘",
        # â€”â€” è¿œå¤„è½¬ç§»
        "è¿œå¤„è½¬ç§»",
        # "è‚ºè½¬ç§»",
        # "è‚è½¬ç§»",
        # "éª¨è½¬ç§»",
        # "è„‘è½¬ç§»",
        "å¤šå‘è½¬ç§»",
        # â€”â€” å±è±¡çŠ¶æ€
        "å†…è„å±è±¡",
        "å±é‡è½¬ç§»",
        "è„å™¨åŠŸèƒ½æ¶åŒ–",
    ],
    "ç—…æƒ…è¯Šæ–­ä¸è¯„ä¼°_è§£æ•‘æ²»ç–—ä¸­": [
        # â€”â€” é˜¶æ®µæ ‡è¯†ï¼ˆé™åˆ¶è¯­å¢ƒï¼‰
        "è§£æ•‘æ²»ç–—",
        "è§£æ•‘æ€§æ²»ç–—",
        "å§‘æ¯æ€§è§£æ•‘æ²»ç–—",
        "æ²»ç–—å¤±è´¥åå†æ¬¡æ²»ç–—",
        "å‰çº¿æ²»ç–—å¤±è´¥",
        "å¤šçº¿æ²»ç–—å¤±è´¥",
        "éš¾æ²»æ€§å¤å‘",
        "è§£æ•‘æ€§åŒ–ç–—",
        "è§£æ•‘æ€§å…ç–«æ²»ç–—",
        "è§£æ•‘æ–¹æ¡ˆ",
        # â€”â€” ç–—æ•ˆè¯„ä¼°æ ‡å‡†è¡¨è¾¾ï¼ˆå¯¹åº”å­—æ®µâ€œç–—æ•ˆè¯„ä¼°â€ï¼‰
        "å®Œå…¨ç¼“è§£",
        "éƒ¨åˆ†ç¼“è§£",
        "ç—…æƒ…ç¨³å®š",
        "ç—…æƒ…è¿›å±•",
        "è€ƒè™‘è¿›å±•",
        "è€ƒè™‘ç¼“è§£",
        "åŸºçº¿è¯„ä¼°",
        "å¤è¯„ç»“è®º",
        "æ— æ³•è¯„ä»·",
        # â€”â€” ç–—æ•ˆè‡ªç„¶è¯­è¨€è¡¨è¾¾ï¼ˆæ¨¡ç³Šã€éæ ‡å‡†æœ¯è¯­ï¼Œç»“åˆâ€œè§£æ•‘â€è¯­å¢ƒï¼‰
        "ç—…ç¶æœªå˜",
        "è‚¿å—ç¼©å°",
        "è½¬ç§»ç¶æ¶ˆé€€",
        "è§£æ•‘æ–¹æ¡ˆåç—…ç¶ç¼©å°",
        "è§£æ•‘æ²»ç–—åç¼“è§£",
        "è§£æ•‘åç—…æƒ…ç¨³å®š",
        "è§£æ•‘æ²»ç–—åæ§åˆ¶è‰¯å¥½",
        # â€”â€” å±è±¡çŠ¶æ€ä¸è¿›å±•
        "å‡ºç°å†…è„å±è±¡",
        "è§£æ•‘æ²»ç–—ä¸­å‡ºç°å†…è„å±è±¡",
        "åŠŸèƒ½å±è±¡",
        "è‚åŠŸèƒ½æ¶åŒ–",
        "æ–°å‘å†…è„è½¬ç§»",
        # â€”â€” è½¬ç§»è¿›å±•ä½ç½®
        "æ–°å‘è‚ºè½¬ç§»",
        "æ–°å‘éª¨è½¬ç§»",
        "è„‘è½¬ç§»è¿›å±•",
        "è‚è½¬ç§»åŠ é‡",
        "è¿œå¤„è½¬ç§»å¢åŠ ",
        # â€”â€” ç–—æ•ˆè¯„ä¼°æ–¹å¼ï¼ˆä¸é˜¶æ®µç»„åˆä½¿ç”¨ï¼‰
        "è§£æ•‘æœŸMRIå¤æŸ¥",
        "è§£æ•‘æ–¹æ¡ˆBè¶…è¯„ä¼°",
        "æŸ¥ä½“æœªè§æ–°ç—…ç¶",
        "Bè¶…æç¤ºè¿›å±•",
        "MRIå¤æŸ¥ç¨³å®š",
    ],
    "ç—…æƒ…è¯Šæ–­ä¸è¯„ä¼°_éšè®¿è·Ÿè¸ªè®°å½•": [
        # â€”â€” é˜¶æ®µæ ‡è¯† / éšè®¿è¡Œä¸º
        "éšè®¿è®°å½•",
        "éšè®¿",
        "éšè®¿ä¸­",
        "é—¨è¯Šéšè®¿",
        "ç”µè¯éšè®¿",
        "å®šæœŸå¤æŸ¥",
        "æŒç»­éšè®¿",
        # â€”â€” ç”Ÿå­˜çŠ¶æ€ç›¸å…³ï¼ˆç»“æ„åŒ–å­—æ®µ: æ˜¯å¦å­˜æ´» / æ­»äº¡æ—¶é—´ / æ­»äº¡ç±»å‹ï¼‰
        "æ˜¯å¦å­˜æ´»",
        "ç›®å‰ç”Ÿå­˜",
        "å·²æ­»äº¡",
        "æ­»äº¡æ—¶é—´",
        "è‚¿ç˜¤ç›¸å…³æ­»äº¡",
        "éè‚¿ç˜¤æ­»äº¡",
        "ç—…æ•…",
        "å› ç—…å»ä¸–",
        "å› ä¹³è…ºç™Œæ­»äº¡",
        # â€”â€” å¤å‘ä¸è¿›å±•ï¼ˆå­—æ®µ: æ˜¯å¦å¤å‘/è¿›å±• / æ˜¯å¦æ–°å‘è„‘è½¬ç§»ï¼‰
        "å¤å‘è¿›å±•",
        "ç—…æƒ…å†æ¬¡è¿›å±•",
        "æ˜¯å¦å¤å‘",
        "å¤å‘æ€§ç—…ç¶",
        "æ–°å‘è„‘è½¬ç§»",
        "æ–°å‡ºç°è„‘è½¬ç§»",
        "è„‘è½¬ç§»å¤å‘",
        # â€”â€” ä¸¥é‡ç—‡çŠ¶ / èº«ä½“çŠ¶å†µï¼ˆå­—æ®µ: èº«ä½“çŠ¶å†µæ˜¯å¦è‰¯å¥½ï¼‰
        "èº«ä½“è™šå¼±",
        "é•¿æœŸå§åºŠ",
        "æ— æ³•è¡Œèµ°",
        "æ— æ³•è¿›é£Ÿ",
        "è¿›é£Ÿå›°éš¾",
        "èº«ä½“çŠ¶æ€è¾ƒå·®",
        "ç”Ÿæ´»æ— æ³•è‡ªç†",
        "é•¿æœŸå§åºŠä¸”æ— æ³•è¡Œèµ°",
        # â€”â€” å¯ç”¨æ–°æ–¹æ¡ˆï¼ˆå­—æ®µ: æ˜¯å¦å¯ç”¨æ–°æ–¹æ¡ˆæ²»ç–—ï¼‰
        "å¯ç”¨æ–°æ–¹æ¡ˆ",
        "è°ƒæ•´æ²»ç–—æ–¹æ¡ˆ",
        "å¼€å§‹æ–°ä¸€è½®æ²»ç–—",
        "è¿›å…¥æ–°æ–¹æ¡ˆ",
        "æ›´æ–°æ²»ç–—æ–¹æ¡ˆ",
        "æ”¹ç”¨æ–°è¯",
    ],
}


# ===========================================================================
# 3. åˆ›å»º / è¿æ¥ ES å®¢æˆ·ç«¯
# ===========================================================================
def get_es_client() -> Elasticsearch:
    if ES_USERNAME and ES_PASSWORD:
        return Elasticsearch(ES_HOST, basic_auth=(ES_USERNAME, ES_PASSWORD))
    return Elasticsearch(ES_HOST)


# ===========================================================================
# 4. å»ºç´¢å¼•ï¼ˆè‹¥å·²å­˜åœ¨åˆ™å…ˆåˆ é™¤ï¼‰
# ===========================================================================
def rebuild_index(es: Elasticsearch):
    if es.indices.exists(index=INDEX_NAME):
        es.indices.delete(index=INDEX_NAME)

    mapping = {
        "mappings": {
            "properties": {
                "cleaned_text": {
                    "type": "text",
                    "analyzer": "standard",  # å¦‚å·²å®‰è£… IK åˆ†è¯ï¼Œå¯æ”¹æˆ ik_max_word
                }
            }
        }
    }
    es.indices.create(index=INDEX_NAME, body=mapping)


# ===========================================================================
# 5. æ‰¹é‡å†™å…¥ Excel æ•°æ®
# ===========================================================================
def bulk_index(es: Elasticsearch, df: pd.DataFrame):
    actions = []
    for i, row in df.iterrows():
        doc_id = row[ID_COL] if ID_COL in df.columns else i
        actions.append(
            {
                "_index": INDEX_NAME,
                "_id": str(doc_id),
                "_source": {"cleaned_text": str(row["cleaned_text"])},
            }
        )
        if len(actions) >= 1000:
            helpers.bulk(es, actions)
            actions.clear()
    if actions:
        helpers.bulk(es, actions)
    es.indices.refresh(index=INDEX_NAME)


# ===========================================================================
# 6. åˆ†ç±»æ£€ç´¢ï¼Œè¿”å› {ä¸­æ–‡åˆ†ç±»å: [id, id, ...]}
# ===========================================================================
def search_categories(es: Elasticsearch) -> Dict[str, List]:
    result = {}
    key_to_process = "ç—…ç†æŠ¥å‘Š_åŸºå› æ£€æµ‹"
    for zh_key, kw_list in category_keywords.items():
        if zh_key != key_to_process:
            continue
        if zh_key == "ç—…æƒ…è¯Šæ–­ä¸è¯„ä¼°_æ–°è¾…åŠ©æ²»ç–—ä¸­":
            context_should = [
                {"match_phrase": {"cleaned_text": ctx}}
                for ctx in [
                    "æ–°è¾…åŠ©æ²»ç–—",
                    "æœ¯å‰æ²»ç–—",
                    "æ–°è¾…åŠ©åŒ–ç–—",
                    "æ–°è¾…åŠ©æ”¾ç–—",
                    "æ–°è¾…åŠ©å†…åˆ†æ³Œ",
                    "æ–°è¾…åŠ©å…ç–«",
                    "æ–°è¾…åŠ©é¶å‘",
                    "æ–°è¾…åŠ©æ–¹æ¡ˆ",
                    "æœ¯å‰åŒ–ç–—",
                    "æœ¯å‰æ”¾ç–—",
                    "æœ¯å‰å†…åˆ†æ³Œ",
                    "æœ¯å‰å…ç–«",
                    "æœ¯å‰é¶å‘",
                    "æœ¯å‰æ–¹æ¡ˆ",
                    "æœ¯å‰ç”¨è¯",
                    "æœ¯å‰å‘¨æœŸ",
                    "æœ¯å‰é˜¶æ®µ",
                    "æ–°è¾…",
                    "æ–°è¾…æ²»",
                    "æ–°è¾…ç–—",
                    "æ–°è¾…åŠ©",
                    "æœ¯å‰",  # ç®€ç§°ç±»
                    "å¼€å§‹æ–°è¾…åŠ©",
                    "è¿›è¡Œæ–°è¾…åŠ©",
                    "æ¥å—æ–°è¾…åŠ©",
                    "ç»™äºˆæ–°è¾…åŠ©",
                    "è¡Œæ–°è¾…åŠ©",
                    "è¿›å…¥æ–°è¾…åŠ©é˜¶æ®µ",
                    "äºˆæ–°è¾…åŠ©",
                    "NAC",
                    "NAT",  # è‹±æ–‡ç¼©å†™
                ]
            ]
            should_clauses = [{"match_phrase": {"cleaned_text": k}} for k in kw_list]

            query = {
                "query": {
                    "bool": {
                        "should": should_clauses + context_should,
                        "minimum_should_match": 2,  # å¿…é¡»åŒæ—¶å‘½ä¸­å†…å®¹å…³é”®è¯å’Œè¯­å¢ƒå…³é”®è¯
                    }
                },
                "_source": False,
                "size": 10000,
            }
        else:
            should_clauses = [{"match_phrase": {"cleaned_text": k}} for k in kw_list]
            query = {
                "query": {
                    "bool": {"should": should_clauses, "minimum_should_match": 1}
                },
                "_source": False,
                "size": 10000,
            }
        resp = es.search(index=INDEX_NAME, body=query)
        ids = [
            int(hit["_id"]) if hit["_id"].isdigit() else hit["_id"]
            for hit in resp["hits"]["hits"]
        ]
        result[zh_key] = ids
        print(f"{zh_key:30s} â†’ {len(ids):4d} æ¡")
    return result


# ===========================================================================
# 7. ä¸»æµç¨‹
# ===========================================================================
def main():
    excel_path = Path(EXCEL_FILE)
    if not excel_path.exists():
        sys.exit(f"âŒ æœªæ‰¾åˆ°æ–‡ä»¶: {excel_path}")

    df = pd.read_excel(excel_path)
    if "cleaned_text" not in df.columns:
        sys.exit("âŒ Excel ä¸­ç¼ºå°‘ cleaned_text åˆ—")

    es = get_es_client()
    print("ğŸš€ æ­£åœ¨é‡å»ºç´¢å¼• â€¦")
    rebuild_index(es)

    print("ğŸ“¥ å†™å…¥æ–‡æ¡£åˆ° ES â€¦")
    bulk_index(es, df)

    print("ğŸ” åˆ†ç±»æ£€ç´¢ â€¦")
    result = search_categories(es)

    output_path = Path(OUTPUT_JSON)
    if output_path.exists():
        output_path.unlink()
        print(f"ğŸ” åˆ é™¤ {output_path}")
    with open(output_path, "w", encoding="utf-8") as f:
        json.dump(result, f, ensure_ascii=False, indent=2)
    print(f"\nâœ… å·²å†™å…¥ {OUTPUT_JSON}")


# ===========================================================================
if __name__ == "__main__":
    main()
