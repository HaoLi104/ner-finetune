# è®­ç»ƒæŒ‡å— - Alias/Title QA æ¨¡å‹

## ğŸ“Š æ•°æ®é›†ä¿¡æ¯

æ ¹æ®é¢„è®¡ç®—ç»“æœï¼š
- **æ€»æ ·æœ¬æ•°**: ~18,952+ 
- **æ­£æ ·æœ¬**: ~88% (16,757)
- **è´Ÿæ ·æœ¬**: ~12% (2,195+)
- **è¾“å…¥è®°å½•**: 2,669 æ¡æŠ¥å‘Š
- **é¢„è®¡ç®—æ–‡ä»¶**: `data/merged.converted.alias_title.jsonl`

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¼€å§‹è®­ç»ƒ

```bash
# ç›´æ¥è¿è¡Œè®­ç»ƒè„šæœ¬ï¼ˆä¼šè‡ªåŠ¨è¯»å– merged_config.jsonï¼‰
python pre_struct/ebqa_title/train_title.py

# æˆ–æŒ‡å®šé…ç½®æ–‡ä»¶
export EBQA_CONFIG_PATH=pre_struct/ebqa_title/merged_config.json
python pre_struct/ebqa_title/train_title.py
```

### 2. ç›‘æ§è®­ç»ƒ

è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨ï¼š
- âœ… æ¯ä¸ª epoch ä¿å­˜ä¸€æ¬¡æ¨¡å‹
- âœ… ä¿å­˜æœ€ä½³æ¨¡å‹åˆ° `runs/ebqa_title_merged/best/`
- âœ… ç”Ÿæˆè®­ç»ƒæ›²çº¿å›¾ `runs/ebqa_title_merged/training_curves.png`
- âœ… è®°å½•è®­ç»ƒæŒ‡æ ‡åˆ° `runs/ebqa_title_merged/metrics_history.json`

### 3. æŸ¥çœ‹ç»“æœ

```bash
# æŸ¥çœ‹è®­ç»ƒæ—¥å¿—
tail -f runs/ebqa_title_merged/train.log

# æŸ¥çœ‹æœ€ä½³æ¨¡å‹
ls -lh runs/ebqa_title_merged/best/
```

---

## âš™ï¸ è®­ç»ƒå‚æ•°è¯¦è§£

### ğŸ¯ æ ¸å¿ƒå‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ | ä¸ºä»€ä¹ˆè¿™æ ·è®¾ç½® |
|------|---|------|--------------|
| **num_train_epochs** | 8 | è®­ç»ƒè½®æ•° | æ•°æ®é‡é€‚ä¸­ï¼Œ8è½®è¶³å¤Ÿæ”¶æ•› |
| **per_device_batch_size** | 8 | æ¯GPUæ‰¹æ¬¡å¤§å° | å¹³è¡¡æ˜¾å­˜å’Œè®­ç»ƒé€Ÿåº¦ |
| **grad_accum_steps** | 4 | æ¢¯åº¦ç´¯ç§¯æ­¥æ•° | æœ‰æ•ˆbatch=8Ã—4=32ï¼Œç¨³å®šè®­ç»ƒ |
| **learning_rate** | 2e-5 | å­¦ä¹ ç‡ | ç•¥ä½äºæ ‡å‡†3e-5ï¼Œæ›´ç¨³å®š |
| **warmup_ratio** | 0.15 | é¢„çƒ­æ¯”ä¾‹ | 15%æ­¥æ•°ç”¨äºé¢„çƒ­ï¼Œé¿å…åˆæœŸéœ‡è¡ |

### ğŸ“Š æ ·æœ¬å¹³è¡¡ç­–ç•¥

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|---|------|
| **use_weighted_sampler** | true | âœ… ä½¿ç”¨åŠ æƒé‡‡æ · |
| **negative_downsample** | 1.0 | âœ… ä¿ç•™å…¨éƒ¨è´Ÿæ ·æœ¬ |
| **short_field_weight** | 2.5 | â¬†ï¸ çŸ­å­—æ®µæƒé‡ï¼ˆæé«˜ç²¾ç¡®ç‡ï¼‰|
| **short_field_boost** | 0.4 | â¬†ï¸ çŸ­å­—æ®µlossåŠ æˆ |

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾ç½®**ï¼š
- è´Ÿæ ·æœ¬åªæœ‰12%ï¼Œéœ€è¦åŠ æƒé‡‡æ ·å¹³è¡¡
- çŸ­å­—æ®µï¼ˆå¦‚å§“åã€æ€§åˆ«ï¼‰æ›´é‡è¦ï¼Œæé«˜æƒé‡
- ä¿ç•™å…¨éƒ¨è´Ÿæ ·æœ¬ï¼Œé¿å…æ¨¡å‹è¿‡åº¦é¢„æµ‹

### ğŸ“ æ­£åˆ™åŒ–å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ | ä½œç”¨ |
|------|---|------|------|
| **label_smoothing** | 0.1 | æ ‡ç­¾å¹³æ»‘ | é˜²æ­¢è¿‡æ‹Ÿåˆ |
| **weight_decay** | 0.01 | æƒé‡è¡°å‡ | L2æ­£åˆ™åŒ– |
| **null_margin** | 0.15 | è´Ÿæ ·æœ¬è¾¹ç•Œ | å¸®åŠ©æ¨¡å‹å­¦ä¼š"ä¸é¢„æµ‹" |
| **null_margin_weight** | 0.05 | è´Ÿæ ·æœ¬æŸå¤±æƒé‡ | å¼ºåŒ–è´Ÿæ ·æœ¬å­¦ä¹  |

**null_margin è¯¦è§£**ï¼š
- å€¼è¶Šå¤§ï¼Œæ¨¡å‹è¶Šå€¾å‘äºä¸é¢„æµ‹ï¼ˆé¿å…è¯¯æŠ¥ï¼‰
- 0.15 æ˜¯é€‚ä¸­çš„å€¼ï¼Œå¹³è¡¡æŸ¥å…¨ç‡å’ŒæŸ¥å‡†ç‡
- é…åˆé«˜çš„ weight (0.05)ï¼Œå¼ºåŒ–è´Ÿæ ·æœ¬å­¦ä¹ 

### â±ï¸ è®­ç»ƒæ§åˆ¶

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|---|------|
| **early_stopping_patience** | 3 | 3è½®ä¸æå‡åˆ™åœæ­¢ |
| **early_stopping_min_delta** | 0.005 | æå‡é˜ˆå€¼ 0.5% |
| **save_every_epochs** | 1 | æ¯è½®ä¿å­˜ checkpoint |
| **best_metric** | token_f1 | æŒ‰ Token F1 é€‰æœ€ä½³æ¨¡å‹ |

### ğŸ”§ é•¿åº¦æ§åˆ¶å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|---|------|
| **length_penalty_weight** | 0.05 | é•¿åº¦æƒ©ç½šæƒé‡ |
| **length_penalty_cap** | 500 | æœ€å¤§æƒ©ç½šä¸Šé™ |
| **length_reasonableness_weight** | 0.1 | é•¿åº¦åˆç†æ€§æƒé‡ |
| **length_reasonableness_scale** | 2.0 | åˆç†æ€§ç¼©æ”¾å› å­ |

**ä½œç”¨**ï¼šé˜²æ­¢æ¨¡å‹é¢„æµ‹è¿‡é•¿æˆ–è¿‡çŸ­çš„ç­”æ¡ˆ

---

## ğŸ“ˆ é¢„æœŸè®­ç»ƒæ•ˆæœ

### è®­ç»ƒæ—¶é•¿

- **å•epochæ—¶é—´**: ~5-10åˆ†é’Ÿï¼ˆå–å†³äºGPUï¼‰
- **æ€»è®­ç»ƒæ—¶é—´**: ~40-80åˆ†é’Ÿï¼ˆ8 epochsï¼‰
- **å¯èƒ½æå‰åœæ­¢**: å¦‚æœ5-6è½®åä¸å†æå‡

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|-------|------|
| **Token F1** | > 85% | ä¸»è¦è¯„ä¼°æŒ‡æ ‡ |
| **Exact Match** | > 75% | å®Œå…¨åŒ¹é…ç‡ |
| **Train Loss** | < 0.5 | è®­ç»ƒæŸå¤± |
| **Eval Loss** | < 0.6 | éªŒè¯æŸå¤± |

### è®­ç»ƒæ›²çº¿ç‰¹å¾

**æ­£å¸¸è®­ç»ƒ**ï¼š
- âœ… Train loss ç¨³å®šä¸‹é™
- âœ… Eval loss åœ¨ 2-3 epoch åè¶‹äºå¹³ç¨³
- âœ… Token F1 æŒç»­ä¸Šå‡åˆ° plateau

**éœ€è¦è­¦æƒ•**ï¼š
- âš ï¸ Eval loss ä¸Šå‡ â†’ è¿‡æ‹Ÿåˆï¼Œæå‰åœæ­¢
- âš ï¸ Train/Eval loss å·®è·è¿‡å¤§ â†’ å¢åŠ æ­£åˆ™åŒ–
- âš ï¸ Loss éœ‡è¡ â†’ é™ä½å­¦ä¹ ç‡

---

## ğŸ”§ å¸¸è§é—®é¢˜è°ƒæ•´

### é—®é¢˜1ï¼šæ˜¾å­˜ä¸è¶³ï¼ˆOOMï¼‰

```json
// ä¿®æ”¹ merged_config.json
"per_device_batch_size": 4,      // 8 â†’ 4
"grad_accum_steps": 8,           // 4 â†’ 8ï¼ˆä¿æŒæœ‰æ•ˆbatch=32ï¼‰
```

### é—®é¢˜2ï¼šè®­ç»ƒå¤ªæ…¢

```json
"num_workers": 4,                // 0 â†’ 4ï¼ˆåŠ å¿«æ•°æ®åŠ è½½ï¼‰
"pin_memory": true,              // ä¿æŒå¼€å¯
```

### é—®é¢˜3ï¼šæ¨¡å‹é¢„æµ‹å¤ªä¿å®ˆï¼ˆæ¼æ£€å¤šï¼‰

```json
"null_margin": 0.1,              // 0.15 â†’ 0.1ï¼ˆé™ä½ï¼‰
"null_margin_weight": 0.02,      // 0.05 â†’ 0.02ï¼ˆé™ä½ï¼‰
```

### é—®é¢˜4ï¼šæ¨¡å‹é¢„æµ‹å¤ªæ¿€è¿›ï¼ˆè¯¯æŠ¥å¤šï¼‰

```json
"null_margin": 0.2,              // 0.15 â†’ 0.2ï¼ˆæé«˜ï¼‰
"null_margin_weight": 0.08,      // 0.05 â†’ 0.08ï¼ˆæé«˜ï¼‰
"label_smoothing": 0.12,         // 0.1 â†’ 0.12ï¼ˆæé«˜ï¼‰
```

### é—®é¢˜5ï¼šçŸ­å­—æ®µæ•ˆæœå·®

```json
"short_field_weight": 3.0,       // 2.5 â†’ 3.0ï¼ˆæé«˜ï¼‰
"short_field_boost": 0.5,        // 0.4 â†’ 0.5ï¼ˆæé«˜ï¼‰
```

---

## ğŸ“ è®­ç»ƒå‘½ä»¤æ±‡æ€»

### åŸºç¡€è®­ç»ƒ
```bash
python pre_struct/ebqa_title/train_title.py
```

### åå°è®­ç»ƒï¼ˆæ¨èï¼‰
```bash
nohup python pre_struct/ebqa_title/train_title.py > train.log 2>&1 &

# æŸ¥çœ‹è¿›åº¦
tail -f train.log
```

### ä» checkpoint æ¢å¤
```bash
# è®­ç»ƒè„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ¢å¤æœ€æ–°çš„ checkpoint
# æ— éœ€é¢å¤–æ“ä½œ
```

### è¯„ä¼°å·²è®­ç»ƒæ¨¡å‹
```bash
python pre_struct/ebqa_title/evaluate_title.py \
    --model_path runs/ebqa_title_merged/best \
    --data_path data/merged.converted.json
```

### æ¨ç†æµ‹è¯•
```bash
# äº¤äº’å¼æµ‹è¯•
python pre_struct/ebqa_title/test_title.py

# æ‰¹é‡æ¨ç†
python scripts/inference_alias_title.py \
    --input data/test.json \
    --output results/predictions.json
```

---

## ğŸ“Š è¾“å‡ºæ–‡ä»¶è¯´æ˜

è®­ç»ƒå®Œæˆåï¼Œ`runs/ebqa_title_merged/` ç›®å½•ç»“æ„ï¼š

```
runs/ebqa_title_merged/
â”œâ”€â”€ best/                          # æœ€ä½³æ¨¡å‹
â”‚   â”œâ”€â”€ config.json
â”‚   â”œâ”€â”€ pytorch_model.bin          # æ¨¡å‹æƒé‡
â”‚   â”œâ”€â”€ tokenizer_config.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ checkpoint-epoch-1/            # æ¯è½®checkpoint
â”œâ”€â”€ checkpoint-epoch-2/
â”œâ”€â”€ ...
â”œâ”€â”€ training_curves.png            # è®­ç»ƒæ›²çº¿å›¾
â”œâ”€â”€ metrics_history.json           # è®­ç»ƒæŒ‡æ ‡å†å²
â””â”€â”€ train.log                      # è®­ç»ƒæ—¥å¿—
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

è®­ç»ƒå®Œæˆåï¼š

1. **è¯„ä¼°æ¨¡å‹**
   ```bash
   python pre_struct/ebqa_title/evaluate_title.py
   ```

2. **æŸ¥çœ‹è®­ç»ƒæ›²çº¿**
   ```bash
   # å›¾ç‰‡ä½äº
   runs/ebqa_title_merged/training_curves.png
   ```

3. **æµ‹è¯•æ¨ç†**
   ```bash
   python pre_struct/ebqa_title/test_title.py
   ```

4. **éƒ¨ç½²æ¨¡å‹**
   - æœ€ä½³æ¨¡å‹ä½äº: `runs/ebqa_title_merged/best/`
   - ç›´æ¥åŠ è½½è¯¥ç›®å½•å³å¯ä½¿ç”¨

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### å¦‚æœ Token F1 < 80%

1. **å¢åŠ è®­ç»ƒæ•°æ®**ï¼šç”Ÿæˆæ›´å¤šè´Ÿæ ·æœ¬
2. **å¢åŠ è®­ç»ƒè½®æ•°**ï¼š8 â†’ 10-12
3. **è°ƒæ•´å­¦ä¹ ç‡**ï¼š2e-5 â†’ 3e-5
4. **å¢åŠ æ¨¡å‹å¤§å°**ï¼šæ¢ç”¨ bert-large

### å¦‚æœè¿‡æ‹Ÿåˆä¸¥é‡

1. **å¢å¼ºæ­£åˆ™åŒ–**ï¼š
   - label_smoothing: 0.1 â†’ 0.15
   - weight_decay: 0.01 â†’ 0.02
2. **å‡å°‘è®­ç»ƒè½®æ•°**ï¼š8 â†’ 6
3. **å¢åŠ æ•°æ®å¢å¼º**ï¼šä½¿ç”¨æ›´å¤šè´Ÿæ ·æœ¬

### å¦‚æœè´Ÿæ ·æœ¬æ•ˆæœå·®

1. **é‡æ–°ç”Ÿæˆæ•°æ®**ï¼šå¢åŠ è´Ÿæ ·æœ¬ chunk
2. **æé«˜è´Ÿæ ·æœ¬æƒé‡**ï¼š
   - null_margin_weight: 0.05 â†’ 0.1
3. **æ£€æŸ¥æ•°æ®è´¨é‡**ï¼šç¡®ä¿è´Ÿæ ·æœ¬å¤šæ ·æ€§

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œæ£€æŸ¥ï¼š
1. è®­ç»ƒæ—¥å¿—: `runs/ebqa_title_merged/train.log`
2. æŒ‡æ ‡å†å²: `runs/ebqa_title_merged/metrics_history.json`
3. é…ç½®æ–‡ä»¶: `pre_struct/ebqa_title/merged_config.json`

