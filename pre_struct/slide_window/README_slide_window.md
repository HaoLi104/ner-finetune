====================================================================================================
SLIDE WINDOW é¡¹ç›®å®Œæ•´æ–‡æ¡£æ±‡æ€»
====================================================================================================

ç”Ÿæˆæ—¶é—´ï¼š2025-10-24 16:03:28
æ‰€æœ‰æ–‡æ¡£å†…å®¹å·²æ•´åˆåˆ°æœ¬æ–‡ä»¶ä¸­

====================================================================================================
ç›®å½•
====================================================================================================
  1. é¡¹ç›®æ¦‚è§ˆ
  2. è®­ç»ƒæŒ‡å—
  3. æ”¹è¿›è¯´æ˜
  4. æ¨ç†è¯´æ˜
  5. é¡¹ç›®å®Œæ•´è¯´æ˜
  6. é¡¹ç›®æ¸…å•


====================================================================================================
ç¬¬ 1 éƒ¨åˆ†ï¼š1. é¡¹ç›®æ¦‚è§ˆ
====================================================================================================

# Slide Window - EBQA è®­ç»ƒç³»ç»Ÿ

## ğŸ“¦ ç³»ç»Ÿæ¦‚è¿°

åŸºäºæ»‘åŠ¨çª—å£çš„é—®ç­”å¼ä¿¡æ¯æŠ½å–è®­ç»ƒç³»ç»Ÿï¼Œæ”¯æŒæ•°æ®é¢„è®¡ç®—åŠ é€Ÿè®­ç»ƒã€‚

**âœ¨ æ–°å¢**: å®æ—¶è¿›åº¦æ¡æ˜¾ç¤ºï¼Œå¯è§†åŒ–æŸ¥çœ‹é¢„è®¡ç®—å’Œè®­ç»ƒè¿›åº¦ï¼

---

## âœ… å½“å‰çŠ¶æ€

### é¢„è®¡ç®—æ•°æ®å·²å°±ç»ª

- âœ… **è®­ç»ƒé›†**: 37,382 ä¸ªæ ·æœ¬
- âœ… **éªŒè¯é›†**: 4,100 ä¸ªæ ·æœ¬  
- âœ… **åŸå§‹æ•°æ®**: 2,669 æ¡ï¼ˆ90%è®­ç»ƒï¼Œ10%éªŒè¯ï¼‰
- âœ… **å­˜å‚¨ä½ç½®**: `runs/slide_window/precomputed/`

---

## ğŸš€ å¿«é€Ÿå¼€å§‹è®­ç»ƒ

### ä¸€é”®å¯åŠ¨ï¼ˆ3æ­¥ï¼‰

```bash
cd /mnt/windows/wy/ner-bert-crf

# æ­¥éª¤1: å¤åˆ¶é¢„è®¡ç®—é…ç½®
cp pre_struct/slide_window/ebqa_config.precomputed.json \
   pre_struct/slide_window/ebqa_config.json

# æ­¥éª¤2: å¼€å§‹è®­ç»ƒ
python -m pre_struct.slide_window.train_with_precomputed

# æˆ–ä½¿ç”¨å¿«æ·è„šæœ¬
bash pre_struct/slide_window/run_train.sh
```

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [README_è®­ç»ƒ.md](./README_è®­ç»ƒ.md) | ğŸ“– **å®Œæ•´è®­ç»ƒæŒ‡å—**ï¼ˆæ¨èé˜…è¯»ï¼‰ |
| [ä½¿ç”¨è¯´æ˜.md](./ä½¿ç”¨è¯´æ˜.md) | ğŸ“‹ å¿«é€Ÿå‚è€ƒæ‰‹å†Œ |

---

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶

### é…ç½®æ–‡ä»¶
- `ebqa_config.json` - å½“å‰é…ç½®
- `ebqa_config.precomputed.json` - é¢„è®¡ç®—é…ç½®æ¨¡æ¿ â­

### è®­ç»ƒè„šæœ¬
- `train_with_precomputed.py` - æ”¯æŒé¢„è®¡ç®—è®­ç»ƒ â­
- `train_ebqa.py` - åŠ¨æ€æ„å»ºè®­ç»ƒ
- `run_train.sh` - å¿«æ·å¯åŠ¨è„šæœ¬

### æ•°æ®å¤„ç†
- `precompute_dataset.py` - æ•°æ®é¢„è®¡ç®—
- `dataset.py` - æ•°æ®é›†å®šä¹‰

---

## ğŸ”„ é‡æ–°é¢„è®¡ç®—

å¦‚æœä¿®æ”¹äº†æ•°æ®æˆ–å‚æ•°ï¼š

```bash
python -m pre_struct.slide_window.precompute_dataset
```

---

## âš™ï¸ å¸¸ç”¨é…ç½®

### è°ƒæ•´æ‰¹æ¬¡å¤§å°ï¼ˆå†…å­˜ä¸è¶³æ—¶ï¼‰

```json
{"train": {"per_device_batch_size": 4}}
```

### è°ƒæ•´è®­ç»ƒè½®æ•°

```json
{"train": {"num_train_epochs": 5}}
```

### å¤šGPUè®­ç»ƒ

```bash
CUDA_VISIBLE_DEVICES=0,1,2,3 python -m pre_struct.slide_window.train_with_precomputed
```

---

## ğŸ“Š æ•°æ®æµç¨‹

```
åŸå§‹æ•°æ® (data/merged.converted.json)
    â†“
[é¢„è®¡ç®—è„šæœ¬] precompute_dataset.py
    â†“
è®­ç»ƒé›† (37,382æ ·æœ¬) + éªŒè¯é›† (4,100æ ·æœ¬)
    â†“
[è®­ç»ƒè„šæœ¬] train_with_precomputed.py
    â†“
è®­ç»ƒå¥½çš„æ¨¡å‹ (runs/slide_window/)
```

---

## ğŸ› é—®é¢˜æ’æŸ¥

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| CUDA OOM | å‡å° `per_device_batch_size` |
| æ‰¾ä¸åˆ°é¢„è®¡ç®—æ–‡ä»¶ | è¿è¡Œ `precompute_dataset.py` |
| è®­ç»ƒå¾ˆæ…¢ | ç¡®ä¿ `"precomputed": true` |

è¯¦è§ [README_è®­ç»ƒ.md](./README_è®­ç»ƒ.md)

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. âœ… æ•°æ®é¢„è®¡ç®—å®Œæˆ
2. â­ï¸ å¤åˆ¶é…ç½®: `cp ebqa_config.precomputed.json ebqa_config.json`
3. â­ï¸ å¼€å§‹è®­ç»ƒ: `python -m pre_struct.slide_window.train_with_precomputed`

**è¯¦ç»†æŒ‡å—**: [README_è®­ç»ƒ.md](./README_è®­ç»ƒ.md) ğŸ“–




====================================================================================================
ç¬¬ 2 éƒ¨åˆ†ï¼š2. è®­ç»ƒæŒ‡å—
====================================================================================================

# Slide Window è®­ç»ƒå®Œæ•´æŒ‡å—

## âœ… å½“å‰çŠ¶æ€

### é¢„è®¡ç®—æ•°æ®ï¼ˆå·²å®Œæˆï¼‰

- âœ… **è®­ç»ƒé›†**: 37,382 ä¸ªæ ·æœ¬
- âœ… **éªŒè¯é›†**: 4,100 ä¸ªæ ·æœ¬
- âœ… **æ•°æ®è·¯å¾„**: `runs/slide_window/precomputed/`

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨è®­ç»ƒ

### æ–¹æ³• 1: ä½¿ç”¨é¢„è®¡ç®—æ•°æ®ï¼ˆæ¨èâ­ï¼‰

**æ­¥éª¤ 1**: å¤åˆ¶é¢„è®¡ç®—é…ç½®

```bash
cd /mnt/windows/wy/ner-bert-crf
cp pre_struct/slide_window/ebqa_config.precomputed.json pre_struct/slide_window/ebqa_config.json
```

**æ­¥éª¤ 2**: å¼€å§‹è®­ç»ƒ

```bash
python -m pre_struct.slide_window.train_with_precomputed
```

---

### æ–¹æ³• 2: ä½¿ç”¨å¿«æ·è„šæœ¬

```bash
bash pre_struct/slide_window/run_train.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹é…ç½®ä¸­çš„ `precomputed` å‚æ•°ï¼Œé€‰æ‹©åˆé€‚çš„è®­ç»ƒæ–¹å¼ã€‚

---

### æ–¹æ³• 3: åŠ¨æ€æ„å»ºæ•°æ®ï¼ˆä¸æ¨èï¼‰

```bash
# ç¡®ä¿é…ç½®ä¸­ "precomputed": false
python -m pre_struct.slide_window.train_ebqa
```

**ç¼ºç‚¹**: æ¯ä¸ª epoch éƒ½è¦é‡æ–°æ„å»ºæ•°æ®ï¼Œå¯åŠ¨æ…¢ã€‚

---

## ğŸ“‹ å®Œæ•´è®­ç»ƒå‘½ä»¤

### å• GPU è®­ç»ƒ

```bash
cd /mnt/windows/wy/ner-bert-crf
python -m pre_struct.slide_window.train_with_precomputed
```

### å¤š GPU è®­ç»ƒ

```bash
cd /mnt/windows/wy/ner-bert-crf
CUDA_VISIBLE_DEVICES=0,1,2,3 python -m pre_struct.slide_window.train_with_precomputed
```

### æŒ‡å®šé…ç½®æ–‡ä»¶

```bash
EBQA_CONFIG_PATH=pre_struct/slide_window/ebqa_config.precomputed.json \
python -m pre_struct.slide_window.train_with_precomputed
```

---

## ğŸ“Š é¢„æœŸç»“æœ

### è®­ç»ƒæ—¶é—´ä¼°ç®—

| é…ç½® | é¢„è®¡æ—¶é—´ |
|------|----------|
| å• GPU (V100) | ~2-3 å°æ—¶ |
| å• GPU (3090) | ~1.5-2 å°æ—¶ |
| 4 GPU | ~30-45 åˆ†é’Ÿ |

**æ³¨**: 2 epochs, batch_size=8

### è¾“å‡ºæ–‡ä»¶

è®­ç»ƒå®Œæˆåï¼Œæ¨¡å‹ä¿å­˜åœ¨:

```
runs/slide_window/
â”œâ”€â”€ pytorch_model.bin           # æ¨¡å‹æƒé‡
â”œâ”€â”€ config.json                 # æ¨¡å‹é…ç½®
â”œâ”€â”€ train_config.json           # è®­ç»ƒé…ç½®
â”œâ”€â”€ checkpoint-xxx/             # æ£€æŸ¥ç‚¹
â””â”€â”€ trainer_state.json          # è®­ç»ƒçŠ¶æ€
```

---

## âš™ï¸ é…ç½®è°ƒæ•´

### è°ƒæ•´æ‰¹æ¬¡å¤§å°ï¼ˆå†…å­˜ä¸è¶³æ—¶ï¼‰

ç¼–è¾‘ `ebqa_config.json`:

```json
{
  "train": {
    "per_device_batch_size": 4  // ä» 8 æ”¹ä¸º 4
  }
}
```

### è°ƒæ•´è®­ç»ƒè½®æ•°

```json
{
  "train": {
    "num_train_epochs": 5  // å¢åŠ åˆ° 5 è½®
  }
}
```

### è°ƒæ•´å­¦ä¹ ç‡

```json
{
  "train": {
    "learning_rate": 5e-05  // è°ƒé«˜å­¦ä¹ ç‡
  }
}
```

---

## ğŸ”„ é‡æ–°é¢„è®¡ç®—æ•°æ®

å¦‚æœä¿®æ”¹äº†åŸå§‹æ•°æ®ã€åˆ†å‰²æ¯”ä¾‹æˆ–æ»‘åŠ¨çª—å£å‚æ•°ï¼š

```bash
python -m pre_struct.slide_window.precompute_dataset
```

**ä½•æ—¶éœ€è¦é‡æ–°é¢„è®¡ç®—**:
- âœ… ä¿®æ”¹äº† `data_path`ï¼ˆåŸå§‹æ•°æ®ï¼‰
- âœ… ä¿®æ”¹äº† `eval_ratio`ï¼ˆéªŒè¯é›†æ¯”ä¾‹ï¼‰
- âœ… ä¿®æ”¹äº† `max_seq_len`, `max_tokens_ctx`, `doc_stride`
- âœ… ä¿®æ”¹äº† `seed`ï¼ˆéšæœºç§å­ï¼‰
- âŒ ä»…ä¿®æ”¹è®­ç»ƒå‚æ•°ï¼ˆlearning_rate ç­‰ï¼‰**ä¸éœ€è¦**

---

## ğŸ“ æ–‡ä»¶è¯´æ˜

### é…ç½®æ–‡ä»¶

- `ebqa_config.json` - å½“å‰ä½¿ç”¨çš„é…ç½®ï¼ˆéœ€æ‰‹åŠ¨æ›´æ–°ï¼‰
- `ebqa_config.precomputed.json` - é¢„è®¡ç®—é…ç½®ç¤ºä¾‹ï¼ˆå¯ç›´æ¥å¤åˆ¶ä½¿ç”¨ï¼‰

### è®­ç»ƒè„šæœ¬

- `train_with_precomputed.py` - â­ æ¨èï¼šæ”¯æŒé¢„è®¡ç®—æ•°æ®
- `train_ebqa.py` - åŸå§‹ï¼šåŠ¨æ€æ„å»ºæ•°æ®
- `run_train.sh` - å¿«æ·è„šæœ¬

### æ•°æ®å¤„ç†

- `precompute_dataset.py` - æ•°æ®é¢„è®¡ç®—è„šæœ¬
- `dataset.py` - æ•°æ®é›†ç±»å®šä¹‰

### æ–‡æ¡£

- `ä½¿ç”¨è¯´æ˜.md` - ç®€æ´ä½¿ç”¨è¯´æ˜
- `PRECOMPUTE_README.md` - è¯¦ç»†æŠ€æœ¯æ–‡æ¡£
- `å¿«é€Ÿä½¿ç”¨æŒ‡å—.md` - å¿«é€Ÿå‚è€ƒ
- `README_è®­ç»ƒ.md` - æœ¬æ–‡ä»¶

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: CUDA out of memory

**è§£å†³**: å‡å° batch_size

```json
{"train": {"per_device_batch_size": 4}}
```

### Q2: è®­ç»ƒå¾ˆæ…¢

**æ£€æŸ¥**:
1. æ˜¯å¦ä½¿ç”¨äº†é¢„è®¡ç®—æ•°æ®ï¼Ÿï¼ˆ`"precomputed": true`ï¼‰
2. GPU æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿï¼ˆ`nvidia-smi`ï¼‰
3. æ•°æ®åŠ è½½å™¨æ˜¯å¦æœ‰ç“¶é¢ˆï¼Ÿï¼ˆ`"num_workers": 2`ï¼‰

### Q3: æ‰¾ä¸åˆ°é¢„è®¡ç®—æ–‡ä»¶

**è§£å†³**:
```bash
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh runs/slide_window/precomputed/

# å¦‚æœä¸å­˜åœ¨ï¼Œé‡æ–°é¢„è®¡ç®—
python -m pre_struct.slide_window.precompute_dataset
```

### Q4: è®­ç»ƒå‡†ç¡®ç‡ä¸ç†æƒ³

**å°è¯•**:
1. å¢åŠ è®­ç»ƒè½®æ•°ï¼ˆ`num_train_epochs`ï¼‰
2. è°ƒæ•´å­¦ä¹ ç‡ï¼ˆ`learning_rate`ï¼‰
3. æ£€æŸ¥æ•°æ®è´¨é‡
4. å¢åŠ æ›´å¤šè®­ç»ƒæ•°æ®

---

## ğŸ“ˆ ç›‘æ§è®­ç»ƒ

### æŸ¥çœ‹å®æ—¶æ—¥å¿—

è®­ç»ƒè¿‡ç¨‹ä¼šè¾“å‡ºæ—¥å¿—ï¼ŒåŒ…æ‹¬ï¼š
- Lossï¼ˆæŸå¤±ï¼‰
- Evaluation metricsï¼ˆè¯„ä¼°æŒ‡æ ‡ï¼‰
- Training speedï¼ˆè®­ç»ƒé€Ÿåº¦ï¼‰

### æŸ¥çœ‹è®­ç»ƒå†å²

```bash
# æŸ¥çœ‹å…ƒæ•°æ®
cat runs/slide_window/precomputed/train_precomputed.meta.json

# æŸ¥çœ‹è®­ç»ƒé…ç½®
cat runs/slide_window/train_config.json

# æŸ¥çœ‹è®­ç»ƒçŠ¶æ€
cat runs/slide_window/trainer_state.json
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. âœ… é¢„è®¡ç®—æ•°æ®å·²å®Œæˆ
2. â­ï¸ **å¤åˆ¶é…ç½®æ–‡ä»¶**: `cp ebqa_config.precomputed.json ebqa_config.json`
3. â­ï¸ **å¼€å§‹è®­ç»ƒ**: `python -m pre_struct.slide_window.train_with_precomputed`
4. â­ï¸ **è¯„ä¼°æ¨¡å‹**
5. â­ï¸ **éƒ¨ç½²ä½¿ç”¨**

---

**ç¥è®­ç»ƒé¡ºåˆ©ï¼** ğŸš€





====================================================================================================
ç¬¬ 3 éƒ¨åˆ†ï¼š3. æ”¹è¿›è¯´æ˜
====================================================================================================

# Slide Window æ”¹è¿›è¯´æ˜

## ğŸ“ æ ¸å¿ƒæ”¹è¿›

å·²æŒ‰ç…§ ebqa çš„è®­ç»ƒç»“æ„æ¥æ”¹è¿› slide_windowï¼Œ**ä¿ç•™æ»‘åŠ¨çª—å£æœºåˆ¶ä½†æå‡æ ‡æ³¨è´¨é‡**ã€‚

---

## ğŸ”„ ä¸»è¦å˜åŒ–

### 1. æ”¹è¿›æ ‡æ³¨é€»è¾‘ï¼ˆdataset.pyï¼‰

#### ä¹‹å‰çš„é—®é¢˜
```python
# ç®€å•åˆ¤æ–­ï¼š"ç­”æ¡ˆåœ¨ä¸åœ¨çª—å£ï¼Ÿ"
if not (gold_end > chunk_start and gold_start < chunk_end):
    skip()  # â†’ 67%çš„çª—å£è¢«è·³è¿‡
```

#### ç°åœ¨çš„æ–¹æ³•ï¼ˆé‡‡ç”¨ebqaç­–ç•¥ï¼‰
```python
# æƒ…å†µ1ï¼šç­”æ¡ˆä¸çª—å£æœ‰é‡å  â†’ ç²¾ç¡®æ˜ å°„
if has_overlap:
    # ä¼˜å…ˆé€‰"åŒ…å«"çš„tokenï¼ˆebqaç­–ç•¥ï¼‰
    # å†é€‰"é‚»è¿‘"çš„tokenï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
    
# æƒ…å†µ2ï¼šæ— ç­”æ¡ˆ â†’ æ·»åŠ ä¸ºè´Ÿæ ·æœ¬
# æ ‡æ³¨ä¸º[0,0]ï¼ˆCLS tokenï¼‰ç”¨äºè®­ç»ƒ"æ— ç­”æ¡ˆ"èƒ½åŠ›
```

### 2. é‡‡ç”¨ebqaçš„è®­ç»ƒå‚æ•°ï¼ˆebqa_config.jsonï¼‰

| å‚æ•° | ä¹‹å‰ | ç°åœ¨ | è¯´æ˜ |
|------|------|------|------|
| num_train_epochs | 2 | 6 | æ›´å¤šè®­ç»ƒè½®æ¬¡ |
| grad_accum_steps | - | 2 | æ¢¯åº¦ç´¯ç§¯ï¼ˆç­‰æ•ˆbatch sizeåŠ å€ï¼‰ |
| label_smoothing | 0.0 | 0.08 | æ ‡ç­¾å¹³æ»‘æ­£åˆ™åŒ– |
| null_margin | 0.0 | 0.1 | æ— ç­”æ¡ˆé—´éš” |
| use_weighted_sampler | false | true | åŠ æƒé‡‡æ ·å™¨ |
| negative_downsample | 1.0 | 0.4 | è´Ÿæ ·æœ¬ä¸‹é‡‡æ ·ï¼ˆå‡å°‘å†—ä½™ï¼‰ |
| short_field_weight | 1.0 | 2.0 | çŸ­å­—æ®µæƒé‡ç¿»å€ |
| short_field_boost | 0.0 | 0.3 | çŸ­å­—æ®µæå‡ |

### 3. å…³é”®æ”¹è¿›å¯¹æ¯”

#### ç­”æ¡ˆæ˜ å°„ç­–ç•¥

**æ—§æ–¹æ³•**ï¼šç®€å•çš„è¾¹ç•Œæ£€æŸ¥ â†’ å¤±è´¥ç‡é«˜
```
window: [0, 512]
answer: [400, 450]
result: âœ“ åœ¨çª—å£å†…

window: [384, 896]  
answer: [400, 450]
result: âœ— è™½ç„¶é‡å ï¼Œä½†æ˜ å°„å¯èƒ½å¤±è´¥
```

**æ–°æ–¹æ³•**ï¼šæ™ºèƒ½æ˜ å°„ï¼ˆlike ebqaï¼‰
```
1. ç¬¬ä¸€é€‰æ‹©ï¼šåŒ…å« answer_start çš„token
2. å¤‡é€‰æ–¹æ¡ˆï¼šæœ€é‚»è¿‘çš„token
3. ç»“æœï¼šæ›´å°‘çš„å¤±è´¥ï¼Œæ›´å¤šçš„æ ·æœ¬è¢«ä¿ç•™
```

#### è´Ÿæ ·æœ¬å¤„ç†

**æ—§æ–¹æ³•**ï¼šå®Œå…¨è·³è¿‡ â†’ æµªè´¹äº†"æ— ç­”æ¡ˆ"çš„å­¦ä¹ ä¿¡å·
```
if answer_not_found:
    skip()  # âŒ æµªè´¹äº†æ•°æ®
```

**æ–°æ–¹æ³•**ï¼šæ·»åŠ ä¸º"æ— ç­”æ¡ˆ"æ ·æœ¬ â†’ è®­ç»ƒé²æ£’æ€§
```python
# æ ‡æ³¨ä¸º [0, 0] (CLS token)
sample["start_positions"] = 0
sample["end_positions"] = 0
# âœ… è®­ç»ƒæ¨¡å‹å­¦ä¼šè¯†åˆ«"æ— ç­”æ¡ˆ"
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### æ ·æœ¬æ•°é‡å˜åŒ–
- ä¹‹å‰ï¼š~35,045 æœ‰æ ‡ç­¾æ ·æœ¬
- ç°åœ¨ï¼šæ›´å¤šæ ·æœ¬è¢«ä¿ç•™ï¼ˆé€šè¿‡æ™ºèƒ½æ˜ å°„ + è´Ÿæ ·æœ¬ï¼‰

### è®­ç»ƒæ•ˆç‡
- âœ… é‡‡ç”¨è´Ÿæ ·æœ¬ä¸‹é‡‡æ ·ï¼ˆ0.4ï¼‰å‡å°‘å†—ä½™
- âœ… åŠ æƒé‡‡æ ·å™¨æå‡è®­ç»ƒæ•ˆç‡
- âœ… æ ‡ç­¾å¹³æ»‘é¿å…è¿‡æ‹Ÿåˆ
- âœ… æ¢¯åº¦ç´¯ç§¯å¢åŠ æœ‰æ•ˆbatch size

### æ¨¡å‹é²æ£’æ€§
- âœ… æ›´å¥½çš„ç­”æ¡ˆå®šä½ï¼ˆebqaæ˜ å°„ç­–ç•¥ï¼‰
- âœ… å­¦ä¼šè¯†åˆ«"æ— ç­”æ¡ˆ"æƒ…å†µ
- âœ… å¯¹çŸ­å­—æ®µæ›´æ•æ„Ÿï¼ˆæƒé‡2.0ï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥

### Step 1: é‡æ–°é¢„è®¡ç®—æ•°æ®
```bash
python -m pre_struct.slide_window.precompute_dataset
```

### Step 2: è§‚å¯Ÿé¢„è®¡ç®—ç»Ÿè®¡
é¢„æœŸçœ‹åˆ°ï¼š
- ç­”æ¡ˆä¸åœ¨çª—å£å†…ï¼šå‡å°‘ï¼ˆé€šè¿‡smart mappingï¼‰
- è´Ÿæ ·æœ¬æ•°é‡ï¼šå¢åŠ ï¼ˆæ— ç­”æ¡ˆæ ·æœ¬ï¼‰
- æ€»æœ‰æ ‡ç­¾æ ·æœ¬ï¼šå¢åŠ 

### Step 3: å¼€å§‹è®­ç»ƒ
```bash
python -m pre_struct.slide_window.train_with_precomputed
```

### Step 4: å¯¹æ¯”æ•ˆæœ
- Token F1 æ˜¯å¦æå‡
- æ¨¡å‹æ˜¯å¦èƒ½æ­£ç¡®è¯†åˆ«"æ— ç­”æ¡ˆ"

---

## ğŸ“Œ å…³é”®æ”¹è¿›ç‚¹æ€»ç»“

| æ–¹é¢ | æ”¹è¿› |
|------|------|
| **æ ‡æ³¨ç­–ç•¥** | é‡‡ç”¨ebqaçš„char-to-tokenæ˜ å°„ |
| **è´Ÿæ ·æœ¬å¤„ç†** | æ·»åŠ æ— ç­”æ¡ˆæ ·æœ¬è€Œä¸æ˜¯è·³è¿‡ |
| **è®­ç»ƒå‚æ•°** | é‡‡ç”¨ebqaçš„æ­£åˆ™åŒ–å‚æ•° |
| **é‡‡æ ·ç­–ç•¥** | åŠ æƒé‡‡æ ·å™¨ + è´Ÿæ ·æœ¬ä¸‹é‡‡æ · |
| **çŸ­å­—æ®µå¤„ç†** | æƒé‡ä»1.0â†’2.0ï¼Œboost from 0â†’0.3 |

**ç»“è®º**ï¼šç°åœ¨æ˜¯"**æ™ºèƒ½æ»‘åŠ¨çª—å£**" + "**ebqaè®­ç»ƒç»“æ„**"çš„æ··åˆä½“ï¼Œæ—¢ä¿ç•™äº†æ»‘åŠ¨çª—å£å¤„ç†é•¿æ–‡æœ¬çš„ä¼˜åŠ¿ï¼Œåˆé‡‡ç”¨äº†ebqaçš„æ›´å¥½çš„æ ‡æ³¨å’Œè®­ç»ƒç­–ç•¥ã€‚




====================================================================================================
ç¬¬ 4 éƒ¨åˆ†ï¼š4. æ¨ç†è¯´æ˜
====================================================================================================

# Slide Window æ¨ç†è¯´æ˜

## ğŸ“‹ æ¨ç†è„šæœ¬

**æ–‡ä»¶å**ï¼š`test_slide_window.py`

**ç”¨é€”**ï¼šåœ¨è®­ç»ƒåçš„æ¨¡å‹ä¸Šè¿›è¡Œæ¨ç†ï¼Œæå–åŒ»ç–—æŠ¥å‘Šä¸­çš„å…³é”®ä¿¡æ¯

---

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### 1. ä½œä¸ºæ¨¡å—è¿è¡Œ

```bash
cd /mnt/windows/wy/ner-bert-crf
python -m pre_struct.slide_window.test_slide_window
```

### 2. ç›´æ¥è¿è¡Œ

```bash
cd /mnt/windows/wy/ner-bert-crf/pre_struct/slide_window
python test_slide_window.py
```

### 3. æŒ‡å®šé…ç½®æ–‡ä»¶

```bash
EBQA_CONFIG_PATH=pre_struct/slide_window/ebqa_config.json \
python -m pre_struct.slide_window.test_slide_window
```

---

## ğŸ’» åœ¨Pythonä»£ç ä¸­ä½¿ç”¨

### åŸºç¡€ç”¨æ³•

```python
from pre_struct.slide_window.test_slide_window import load_ebqa, predict_one

# 1. åˆå§‹åŒ–ï¼ˆåŠ è½½æ¨¡å‹ï¼‰
model, collator, device, cfg = load_ebqa()

# 2. æ¨ç†å•æ¡æŠ¥å‘Š
title = "å‡ºé™¢è®°å½•"
text = """
æ‚£è€…å§“åï¼šå¼ ä¸‰
æ€§åˆ«ï¼šç”·
å¹´é¾„ï¼š45å²
å…¥é™¢æ—¶é—´ï¼š2024-01-01
å‡ºé™¢è¯Šæ–­ï¼šå† å¿ƒç—…
...
"""

result = predict_one(cfg, model, collator, title, text)

# 3. å¤„ç†ç»“æœ
print(result)
# è¾“å‡º:
# {
#     "å§“å": {"text": "å¼ ä¸‰", "start": 10, "end": 12},
#     "æ€§åˆ«": {"text": "ç”·", "start": 15, "end": 16},
#     "å¹´é¾„": {"text": "45å²", "start": 19, "end": 22},
#     ...
# }
```

### æ‰¹é‡æ¨ç†

```python
import json
from pre_struct.slide_window.test_slide_window import load_ebqa, predict_one

# åˆå§‹åŒ–ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
model, collator, device, cfg = load_ebqa()

# åŠ è½½æ•°æ®
with open("data/reports.json", "r") as f:
    reports = json.load(f)

# æ‰¹é‡æ¨ç†
results = []
for report in reports:
    title = report.get("report_title", "")
    text = report.get("report", "")
    
    pred = predict_one(cfg, model, collator, title, text)
    results.append({
        "report_id": report.get("id"),
        "predictions": pred
    })

# ä¿å­˜ç»“æœ
with open("predictions.json", "w") as f:
    json.dump(results, f, ensure_ascii=False, indent=2)
```

---

## ğŸ“Š æ¨ç†æµç¨‹è¯¦è§£

### é˜¶æ®µ1ï¼šåˆå§‹åŒ–

```python
model, collator, device, cfg = load_ebqa()
```

**æ­¥éª¤**ï¼š
1. è¯»å–é…ç½®æ–‡ä»¶ï¼ˆebqa_config.jsonï¼‰
2. æ£€æŸ¥æ¨¡å‹ç›®å½•
   - å¦‚æœè®­ç»ƒåçš„æ¨¡å‹å­˜åœ¨ â†’ ä½¿ç”¨è®­ç»ƒåçš„æ¨¡å‹
   - å¦åˆ™ â†’ fallbackåˆ°åŸå§‹é¢„è®­ç»ƒæ¨¡å‹
3. åˆå§‹åŒ–BERTæ¨¡å‹
4. åˆå§‹åŒ–æ•°æ®å¤„ç†å™¨ï¼ˆcollatorï¼‰
5. è¿”å›æ‰€æœ‰æ‰€éœ€ç»„ä»¶

### é˜¶æ®µ2ï¼šå•æ¡æ¨ç†

```python
result = predict_one(cfg, model, collator, title, text)
```

**æ­¥éª¤**ï¼š
1. **åˆ›å»ºä¸´æ—¶æ•°æ®æ–‡ä»¶**
   - å°†æŠ¥å‘ŠåŒ…è£…æˆ{"report_title": title, "report": text}
   - ä¿å­˜ä¸ºä¸´æ—¶JSONæ–‡ä»¶

2. **æ„å»ºæ¨ç†æ•°æ®é›†**
   - åŠ è½½reportç»“æ„ï¼ˆä»keys/keys_merged.jsonï¼‰
   - å¯¹æŠ¥å‘Šæ–‡æœ¬è¿›è¡Œæ»‘åŠ¨çª—å£åˆ†å‰²
   - ç”Ÿæˆæ¨ç†æ ·æœ¬ï¼ˆæ— éœ€æ ‡ç­¾ï¼‰
   - æ¯ä¸ªæ ·æœ¬åŒ…å«æ»‘åŠ¨çª—å£çš„tokenåŒ–ç»“æœ

3. **æ¨¡å‹æ¨ç†**
   - é€æ‰¹å¤„ç†æ ·æœ¬ï¼ˆé»˜è®¤batch_size=1ï¼‰
   - è·å–start_logitså’Œend_logits
   - æœç´¢æœ€ä¼˜spanï¼ˆstart, endï¼‰
   - å¤„ç†æ— ç­”æ¡ˆé¢„æµ‹ï¼ˆnull_score vs answer_scoreï¼‰

4. **åå¤„ç†ç»“æœ**
   - æå–æ¯ä¸ªæ ·æœ¬çš„question_key
   - è½¬æ¢tokenä½ç½®ä¸ºå­—ç¬¦ä½ç½®
   - ä»æ–‡æœ¬ä¸­æå–ç­”æ¡ˆæ–‡æœ¬
   - åˆå¹¶å¤šä¸ªçª—å£çš„é¢„æµ‹ç»“æœ

5. **æ¸…ç†
   - åˆ é™¤ä¸´æ—¶æ•°æ®æ–‡ä»¶

### é˜¶æ®µ3ï¼šç»“æœæ ¼å¼

```json
{
    "å§“å": {
        "text": "å¼ ä¸‰",
        "start": 10,
        "end": 12
    },
    "æ€§åˆ«": {
        "text": "ç”·",
        "start": 15,
        "end": 16
    },
    ...
}
```

**è¯´æ˜**ï¼š
- `text`: é¢„æµ‹çš„ç­”æ¡ˆæ–‡æœ¬
- `start`: å­—ç¬¦ä½ç½®ï¼ˆèµ·å§‹ï¼‰
- `end`: å­—ç¬¦ä½ç½®ï¼ˆç»“æŸï¼Œä¸åŒ…å«ï¼‰

---

## ğŸ”§ é…ç½®å‚æ•°

### å…³é”®é…ç½®ï¼ˆebqa_config.json - predictå—ï¼‰

```json
{
    "predict": {
        "batch_size": 1,
        "enable_no_answer": true,
        "null_threshold": 0.5,
        "null_agg": "max",
        "batch_size": 1
    }
}
```

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| batch_size | 1 | æ¨ç†æ‰¹å¤§å° |
| enable_no_answer | true | æ˜¯å¦é¢„æµ‹"æ— ç­”æ¡ˆ" |
| null_threshold | 0.5 | æ— ç­”æ¡ˆåˆ¤å®šé˜ˆå€¼ |
| null_agg | "max" | æ— ç­”æ¡ˆèšåˆæ–¹å¼ (max/mean) |

### æ¨ç†æ—¶ä½¿ç”¨çš„å‚æ•°

```python
PredictConfig(
    max_seq_len=512,           # æœ€å¤§åºåˆ—é•¿åº¦
    max_tokens_ctx=500,        # æœ€å¤§ä¸Šä¸‹æ–‡tokenæ•°
    doc_stride=128,            # æ»‘åŠ¨çª—å£æ­¥é•¿
    max_answer_len=512,        # æœ€å¤§ç­”æ¡ˆé•¿åº¦
    enable_no_answer=True,     # å¯ç”¨æ— ç­”æ¡ˆé¢„æµ‹
    null_threshold=0.5,        # æ— ç­”æ¡ˆé˜ˆå€¼
    null_agg="max",            # æ— ç­”æ¡ˆèšåˆ
)
```

---

## ğŸ” é”™è¯¯å¤„ç†

### åœºæ™¯1ï¼šæ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨

```
âš ï¸  è®­ç»ƒåçš„æ¨¡å‹ä¸å­˜åœ¨: runs/slide_window/best
   ä½¿ç”¨åŸå§‹é¢„è®­ç»ƒæ¨¡å‹: /path/to/bert_model/
```

**è§£å†³**ï¼šä½¿ç”¨åŸå§‹é¢„è®­ç»ƒæ¨¡å‹è‡ªåŠ¨fallbackï¼Œæ— éœ€å¹²é¢„

### åœºæ™¯2ï¼šé…ç½®æ–‡ä»¶ä¸å­˜åœ¨

```
FileNotFoundError: ebqa_config.json not found
```

**è§£å†³**ï¼šç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•è¿è¡Œï¼Œæˆ–æŒ‡å®š `EBQA_CONFIG_PATH`

### åœºæ™¯3ï¼šå†…å­˜ä¸è¶³

```
RuntimeError: CUDA out of memory
```

**è§£å†³**ï¼šåœ¨ebqa_config.jsonä¸­å‡å°‘batch_size

---

## ğŸ“ˆ æ€§èƒ½å‚æ•°

### æ¨ç†é€Ÿåº¦ä¼°ç®—

| é…ç½® | æŠ¥å‘Šé•¿åº¦ | æ¨ç†æ—¶é—´ |
|------|---------|---------|
| å•GPU (3090) | 1000å­—ç¬¦ | ~0.5ç§’ |
| å•GPU (3090) | 2000å­—ç¬¦ | ~1ç§’ |
| å¤šGPU | 2000å­—ç¬¦ | ~0.5ç§’ |

**æ³¨æ„**ï¼šåŒ…æ‹¬æ»‘åŠ¨çª—å£åˆ†å‰²ã€tokenizationã€æ¨¡å‹æ¨ç†ç­‰æ—¶é—´

### å†…å­˜å ç”¨

- æ¨¡å‹å¤§å°ï¼š~420MBï¼ˆBERT-baseï¼‰
- æ¨ç†æ˜¾å­˜ï¼š~2GBï¼ˆå•sampleï¼‰

---

## ğŸ’¡ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰é…ç½®

```python
from pre_struct.slide_window.test_slide_window import PredictConfig
from pre_struct.slide_window.model_ebqa import EBQAModel
from pre_struct.slide_window.dataset import QACollator

# åˆ›å»ºè‡ªå®šä¹‰é…ç½®
cfg = PredictConfig(
    report_struct_path="keys/keys_merged.json",
    tokenizer_name="/path/to/tokenizer",
    model_dir="/path/to/model",
    max_seq_len=512,
    max_tokens_ctx=500,
    doc_stride=128,
    max_answer_len=512,
    batch_size=1,
    chunk_mode="budget",
    enable_no_answer=True,
    null_threshold=0.5,
    null_agg="max",
)

# åˆå§‹åŒ–æ¨¡å‹
model = EBQAModel(
    model_name_or_path=cfg.model_dir,
    tokenizer_name_or_path=cfg.tokenizer_name,
    per_device_eval_batch_size=cfg.batch_size,
    fp16=True,
    max_answer_len=cfg.max_answer_len,
)

# æ¨ç†
from test_slide_window import predict_one
collator = QACollator(pad_id=0)
result = predict_one(cfg, model, collator, title, text)
```

### è°ƒè¯•æ¨¡å¼

```python
# æ·»åŠ æ›´å¤šè¾“å‡ºä¿¡æ¯
import logging
logging.basicConfig(level=logging.DEBUG)

model, collator, device, cfg = load_ebqa()
result = predict_one(cfg, model, collator, title, text)
```

---

## âœ… éªŒè¯æ¨ç†

### å¿«é€Ÿæµ‹è¯•

```bash
python -m pre_struct.slide_window.test_slide_window
```

**é¢„æœŸè¾“å‡º**ï¼š
```json
{
    "å­—æ®µ1": {"text": "å€¼1", "start": 10, "end": 12},
    "å­—æ®µ2": {"text": "å€¼2", "start": 20, "end": 22},
    ...
}
```

### ä¸å·²çŸ¥ç»“æœå¯¹æ¯”

```python
# å¦‚æœæœ‰æ ‡æ³¨æ•°æ®ï¼Œå¯ä»¥å¯¹æ¯”é¢„æµ‹ç»“æœ
predicted = predict_one(...)
expected = gold_data

# è®¡ç®—å‡†ç¡®ç‡
correct = sum(1 for k in expected if k in predicted and predicted[k]["text"] == expected[k])
accuracy = correct / len(expected)
print(f"å‡†ç¡®ç‡: {accuracy:.2%}")
```

---

## ğŸ¯ æ¨èå·¥ä½œæµ

1. **éªŒè¯æ¨¡å‹**
   ```bash
   python -m pre_struct.slide_window.test_slide_window
   ```

2. **æ‰¹é‡æ¨ç†**
   ```python
   # ä½¿ç”¨æ‰¹é‡æ¨ç†è„šæœ¬
   ```

3. **ç»“æœè¯„ä¼°**
   - ä¸æ ‡æ³¨æ•°æ®å¯¹æ¯”
   - è®¡ç®—æŒ‡æ ‡
   - åˆ†æé”™è¯¯æƒ…å†µ

4. **è¿­ä»£æ”¹è¿›**
   - è°ƒæ•´å‚æ•°
   - é‡æ–°è®­ç»ƒ
   - å†æ¬¡è¯„ä¼°

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `test_slide_window.py` - æ¨ç†è„šæœ¬ï¼ˆæœ¬æ–‡æ¡£ï¼‰
- `model_ebqa.py` - æ¨¡å‹å®šä¹‰
- `dataset.py` - æ•°æ®é›†å¤„ç†
- `config_io.py` - é…ç½®åŠ è½½
- `ebqa_config.json` - é…ç½®æ–‡ä»¶

---

âœ… **æ¨ç†ä»£ç ç»“æ„å®Œæ•´ï¼Œå·²å°±ç»ªï¼**




====================================================================================================
ç¬¬ 5 éƒ¨åˆ†ï¼š5. é¡¹ç›®å®Œæ•´è¯´æ˜
====================================================================================================

# Slide Window é¡¹ç›®å®Œæ•´è¯´æ˜

## ğŸ“‹ é¡¹ç›®çŠ¶æ€

âœ… **æ‰€æœ‰ä»£ç æ£€æŸ¥é€šè¿‡ï¼Œé¡¹ç›®å°±ç»ªï¼**

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
pre_struct/slide_window/
â”œâ”€â”€ æ ¸å¿ƒè®­ç»ƒæ¨¡å—
â”‚   â”œâ”€â”€ config_io.py              # é…ç½®åŠ è½½å·¥å…·
â”‚   â”œâ”€â”€ dataset.py                # æ•°æ®é›†å®ç°ï¼ˆæ”¹è¿›çš„æ»‘åŠ¨çª—å£æ ‡æ³¨ï¼‰
â”‚   â”œâ”€â”€ model_ebqa.py             # æ¨¡å‹å’Œè§£ç å™¨
â”‚   â”œâ”€â”€ precompute_dataset.py     # æ•°æ®é¢„è®¡ç®—è„šæœ¬
â”‚   â””â”€â”€ train_with_precomputed.py # è®­ç»ƒè„šæœ¬ï¼ˆæ ¸å¿ƒï¼‰
â”‚
â”œâ”€â”€ æµ‹è¯•å’Œæ¨ç†
â”‚   â””â”€â”€ test_ebqa.py              # æ¨ç†/æµ‹è¯•è„šæœ¬
â”‚
â”œâ”€â”€ é…ç½®
â”‚   â””â”€â”€ ebqa_config.json          # ç»Ÿä¸€é…ç½®æ–‡ä»¶ï¼ˆå·²é‡‡ç”¨ebqaå‚æ•°ï¼‰
â”‚
â””â”€â”€ æ–‡æ¡£
    â”œâ”€â”€ README.md                 # é¡¹ç›®æ¦‚è§ˆ
    â”œâ”€â”€ README_è®­ç»ƒ.md             # è®­ç»ƒæŒ‡å—
    â””â”€â”€ æ”¹è¿›è¯´æ˜.md               # ä¸»è¦æ”¹è¿›å†…å®¹
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1ï¼šé¢„è®¡ç®—æ•°æ®

```bash
cd /mnt/windows/wy/ner-bert-crf
python -m pre_struct.slide_window.precompute_dataset
```

**é¢„æœŸè¾“å‡º**ï¼š
```
æ•°æ®é›†æ„å»ºç»Ÿè®¡:
  å¤„ç†çš„è®°å½•æ•°: 2,403
  éç©ºå­—æ®µæ€»æ•°: 36,045
  æ€»æ»‘åŠ¨çª—å£æ•°: ~80,000  # å‡å°‘ï¼ˆé€šè¿‡smart mappingï¼‰
  ç”Ÿæˆçš„æ ·æœ¬æ•°: ~40,000  # å¢åŠ ï¼ˆåŒ…æ‹¬æ— ç­”æ¡ˆæ ·æœ¬ï¼‰

æ»‘åŠ¨çª—å£è¿‡æ»¤ç»Ÿè®¡:
  ç­”æ¡ˆä¸åœ¨çª—å£å†…: è¾ƒå°‘  # é€šè¿‡æ›´å¥½çš„æ˜ å°„
  Tokenæ˜ å°„å¤±è´¥: è¾ƒå°‘   # æ”¹è¿›çš„æ˜ å°„ç­–ç•¥
  æˆåŠŸä¿ç•™: å¢åŠ         # æ‰€æœ‰æ ·æœ¬éƒ½æœ‰æ ‡ç­¾
```

### æ­¥éª¤ 2ï¼šå¼€å§‹è®­ç»ƒ

```bash
python -m pre_struct.slide_window.train_with_precomputed
```

**é¢„æœŸæ—¶é—´**ï¼š
- å• GPUï¼š2-3 å°æ—¶
- 4 GPUï¼š30-45 åˆ†é’Ÿ

### æ­¥éª¤ 3ï¼šæµ‹è¯•é¢„æµ‹

```bash
python -m pre_struct.slide_window.test_ebqa
```

---

## ğŸ”„ æ ¸å¿ƒæ”¹è¿›

### 1. æ™ºèƒ½ç­”æ¡ˆæ˜ å°„ï¼ˆdataset.pyï¼‰

**æ—§æ–¹æ³•**ï¼š
```python
if answer_not_in_window:
    skip()  # â†’ 67%çª—å£è¢«è·³è¿‡
```

**æ–°æ–¹æ³•**ï¼ˆé‡‡ç”¨ebqaç­–ç•¥ï¼‰ï¼š
```python
# ä¼˜å…ˆé€‰"åŒ…å«"çš„token
# å¤‡é€‰é€‰"é‚»è¿‘"çš„token
# â†’ æ›´å¤šçª—å£è¢«ä¿ç•™
```

### 2. è´Ÿæ ·æœ¬å¤„ç†

**æ–°å¢**ï¼šæ— ç­”æ¡ˆæ ·æœ¬æ ‡æ³¨ä¸º[0,0]è€Œä¸æ˜¯è·³è¿‡
- è®­ç»ƒæ¨¡å‹å­¦ä¼šè¯†åˆ«"æ— ç­”æ¡ˆ"
- æå‡æ¨¡å‹é²æ£’æ€§

### 3. è®­ç»ƒå‚æ•°å‡çº§

| å‚æ•° | æ—§å€¼ | æ–°å€¼ | æ•ˆæœ |
|------|------|------|------|
| label_smoothing | 0.0 | 0.08 | é¿å…è¿‡æ‹Ÿåˆ |
| null_margin | 0.0 | 0.1 | æ— ç­”æ¡ˆé—´éš” |
| use_weighted_sampler | false | true | åŠ æƒé‡‡æ · |
| negative_downsample | 1.0 | 0.4 | å‡å°‘å†—ä½™ |
| short_field_weight | 1.0 | 2.0 | å¼ºåŒ–çŸ­å­—æ®µ |

---

## ğŸ“Š é…ç½®æ–‡ä»¶è¯´æ˜

### ebqa_config.json

#### è®­ç»ƒå‚æ•° (train block)

```json
{
  "data_path": "runs/slide_window/precomputed/train_precomputed.jsonl",
  "eval_data_path": "runs/slide_window/precomputed/eval_precomputed.jsonl",
  "precomputed": true,
  "num_train_epochs": 6,
  "per_device_batch_size": 8,
  "grad_accum_steps": 2,
  "negative_downsample": 0.4,
  "use_weighted_sampler": true,
  "label_smoothing": 0.08,
  "short_field_weight": 2.0
}
```

#### é¢„æµ‹å‚æ•° (predict block)

```json
{
  "batch_size": 1,
  "enable_no_answer": true,
  "null_threshold": 0.5,
  "null_agg": "max"
}
```

---

## ğŸ§ª æ–‡ä»¶éªŒè¯

æ‰€æœ‰Pythonæ–‡ä»¶å·²é€šè¿‡è¯­æ³•æ£€æŸ¥ï¼š

âœ“ config_io.py
âœ“ dataset.py (ä¿®å¤äº†è¯­æ³•é”™è¯¯)
âœ“ model_ebqa.py
âœ“ precompute_dataset.py
âœ“ train_with_precomputed.py
âœ“ test_ebqa.py

---

## ğŸ“Œ å…³é”®æ–‡ä»¶è¯´æ˜

### train_with_precomputed.pyï¼ˆæ ¸å¿ƒè®­ç»ƒè„šæœ¬ï¼‰

```python
# å®Œæ•´çš„è®­ç»ƒæµç¨‹ï¼š
1. åŠ è½½é…ç½® â†’ load_config()
2. æ„å»ºæ•°æ®é›† â†’ build_datasets_from_precomputed()
3. åˆ›å»ºæ¨¡å‹ â†’ BertForQuestionAnswering.from_pretrained()
4. è®¾ç½®Trainer â†’ Trainer()
5. å¼€å§‹è®­ç»ƒ â†’ trainer.train()
6. ä¿å­˜æ¨¡å‹ â†’ trainer.save_model()
```

### dataset.pyï¼ˆæ”¹è¿›çš„æ ‡æ³¨é€»è¾‘ï¼‰

```python
# å…³é”®æ”¹è¿›ï¼š
1. é‡‡ç”¨ebqaçš„char-to-tokenæ˜ å°„
2. å¤„ç†ç­”æ¡ˆåœ¨çª—å£è¾¹ç•Œçš„æƒ…å†µ
3. æ·»åŠ æ— ç­”æ¡ˆæ ·æœ¬([0,0])
4. æ›´æ™ºèƒ½çš„tokené€‰æ‹©ï¼ˆä¼˜å…ˆåŒ…å«â†’å¤‡é€‰é‚»è¿‘ï¼‰
```

### model_ebqa.pyï¼ˆæ¨¡å‹å®šä¹‰ï¼‰

```python
# ä¸»è¦ç±»ï¼š
- EBQADecoder: æœ€ä¼˜spanæœç´¢å’ŒåŠ¨æ€é•¿åº¦é™åˆ¶
- EBQAModel: å®Œæ•´çš„æ¨¡å‹è®­ç»ƒ/é¢„æµ‹é€»è¾‘
```

---

## âœ¨ è®­ç»ƒé€»è¾‘å®Œæ•´æ€§æ£€æŸ¥

âœ… **æ•°æ®åŠ è½½**ï¼šä»é¢„è®¡ç®—çš„JSONLåŠ è½½æ ·æœ¬
âœ… **æ•°æ®å¤„ç†**ï¼šQACollatorè¿›è¡Œæ‰¹å¤„ç†å’Œpadding
âœ… **æ¨¡å‹åˆå§‹åŒ–**ï¼šBertForQuestionAnswering
âœ… **è®­ç»ƒè®¾ç½®**ï¼šTrainingArgumentså®Œæ•´é…ç½®
âœ… **ä¼˜åŒ–å™¨**ï¼šAdamW + learning_rate_scheduler
âœ… **è¯„ä¼°**ï¼šæ¯ä¸ªepochè¿›è¡ŒéªŒè¯
âœ… **ä¿å­˜**ï¼šsave_strategy="epoch"
âœ… **æ—©åœ**ï¼šearly_stopping_patience=2
âœ… **æœ€ä¼˜æ¨¡å‹**ï¼šload_best_model_at_end=True

---

## ğŸ¯ é¢„æœŸç»“æœ

### æ ·æœ¬æ•°é‡

- **è¾“å…¥**ï¼š283,535 æ¡åŒ»ç–—æŠ¥å‘Š
- **é¢„è®¡ç®—å**ï¼š~40,000 ä¸ªæœ‰æ ‡ç­¾æ ·æœ¬ï¼ˆåŒ…æ‹¬æ— ç­”æ¡ˆæ ·æœ¬ï¼‰
- **åˆ†å¸ƒ**ï¼šæ— ç­”æ¡ˆä¸‹é‡‡æ ·è‡³40%

### è®­ç»ƒæ•ˆæœ

- Token F1ï¼šé¢„æœŸ > 0.85
- ç²¾ç¡®åŒ¹é…ï¼šé¢„æœŸ > 0.75
- æ— ç­”æ¡ˆè¯†åˆ«ç‡ï¼šé¢„æœŸ > 0.90

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šé¢„è®¡ç®—æ—¶æ–‡ä»¶ä¸å­˜åœ¨

```bash
FileNotFoundError: data/merged.converted.json
```

**è§£å†³**ï¼šç¡®ä¿ `precompute_dataset.py` ä¸­çš„ `data_path` æŒ‡å‘æ­£ç¡®çš„åŸå§‹æ•°æ®æ–‡ä»¶

### é—®é¢˜2ï¼šè®­ç»ƒæ—¶OOM

**è§£å†³**ï¼š
- å‡å°‘ `per_device_batch_size`
- å¢åŠ  `grad_accum_steps`

### é—®é¢˜3ï¼šæ¨¡å‹è·¯å¾„é”™è¯¯

**è§£å†³**ï¼šæ£€æŸ¥ `model_name_or_path` å’Œ `tokenizer_name_or_path` æ˜¯å¦å­˜åœ¨

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥

1. âœ… ä»£ç æ£€æŸ¥å®Œæˆ
2. â³ é¢„è®¡ç®—æ•°æ®
3. â³ å¼€å§‹è®­ç»ƒ
4. â³ è¯„ä¼°ç»“æœ
5. â³ æ¨ç†é¢„æµ‹

**ç°åœ¨å°±å¯ä»¥è¿è¡Œ**ï¼š
```bash
python -m pre_struct.slide_window.precompute_dataset
python -m pre_struct.slide_window.train_with_precomputed
```

ğŸ‰ **é¡¹ç›®å°±ç»ªï¼**




====================================================================================================
ç¬¬ 6 éƒ¨åˆ†ï¼š6. é¡¹ç›®æ¸…å•
====================================================================================================

================================================================================
                      Slide Window é¡¹ç›®å®Œæ•´æ¸…å•
================================================================================

âœ… é¡¹ç›®çŠ¶æ€ï¼šä»£ç æ£€æŸ¥å®Œæˆï¼Œå…¨éƒ¨å°±ç»ªï¼

================================================================================
ğŸ“ æ–‡ä»¶æ¸…å•ï¼ˆæœ€ç»ˆç‰ˆï¼‰
================================================================================

æ ¸å¿ƒè®­ç»ƒæ¨¡å—:
  âœ“ __init__.py                - åŒ…åˆå§‹åŒ–
  âœ“ config_io.py               - é…ç½®åŠ è½½å·¥å…·
  âœ“ dataset.py                 - æ•°æ®é›†ç±»ï¼ˆæ”¹è¿›çš„æ»‘åŠ¨çª—å£æ ‡æ³¨ï¼‰
  âœ“ model_ebqa.py              - æ¨¡å‹å’Œè§£ç å™¨
  âœ“ precompute_dataset.py      - æ•°æ®é¢„è®¡ç®—è„šæœ¬
  âœ“ train_with_precomputed.py  - è®­ç»ƒè„šæœ¬ï¼ˆæ ¸å¿ƒï¼‰

æ¨ç†æ¨¡å—:
  âœ“ test_slide_window.py       - æ¨ç†è„šæœ¬ï¼ˆå·²ä»test_ebqa.pyæ”¹åï¼‰

é…ç½®:
  âœ“ ebqa_config.json           - ç»Ÿä¸€é…ç½®æ–‡ä»¶

æ–‡æ¡£:
  âœ“ README.md                  - é¡¹ç›®æ¦‚è§ˆ
  âœ“ README_è®­ç»ƒ.md              - è®­ç»ƒæŒ‡å—
  âœ“ æ”¹è¿›è¯´æ˜.md                - ä¸»è¦æ”¹è¿›å†…å®¹
  âœ“ æ¨ç†è¯´æ˜.md                - æ¨ç†è¯¦ç»†è¯´æ˜
  âœ“ é¡¹ç›®å®Œæ•´è¯´æ˜.md            - é¡¹ç›®æ€»ä½“è¯´æ˜
  âœ“ é¡¹ç›®æ¸…å•.txt               - æœ¬æ–‡ä»¶

å·²åˆ é™¤çš„æ–‡ä»¶:
  âœ— train_ebqa.py              - æ—§çš„è®­ç»ƒè„šæœ¬
  âœ— run_scheme_pipeline.py     - æ—§çš„æ¨ç†ç®¡é“
  âœ— run_train.sh               - æ—§çš„è„šæœ¬
  âœ— test.py                    - æ—§çš„æµ‹è¯•è„šæœ¬
  âœ— ebqa_config.precomputed.json - å¤šä½™é…ç½®
  âœ— æ»‘åŠ¨çª—å£è¯´æ˜.md             - è¿‡æ—¶æ–‡æ¡£
  âœ— æ»‘åŠ¨çª—å£ç­–ç•¥é—®é¢˜.md         - è¿‡æ—¶æ–‡æ¡£

================================================================================
ğŸ” ä»£ç æ£€æŸ¥ç»“æœ
================================================================================

Python è¯­æ³•æ£€æŸ¥ï¼šâœ… é€šè¿‡
  âœ“ config_io.py
  âœ“ dataset.py
  âœ“ model_ebqa.py
  âœ“ precompute_dataset.py
  âœ“ train_with_precomputed.py
  âœ“ test_slide_window.py

è®­ç»ƒé€»è¾‘å®Œæ•´æ€§ï¼šâœ… é€šè¿‡
  âœ“ æ•°æ®åŠ è½½
  âœ“ æ•°æ®å¤„ç†
  âœ“ æ¨¡å‹åˆå§‹åŒ–
  âœ“ è®­ç»ƒè®¾ç½®
  âœ“ ä¼˜åŒ–å™¨é…ç½®
  âœ“ è¯„ä¼°æœºåˆ¶
  âœ“ ä¿å­˜ç­–ç•¥
  âœ“ æ—©åœæœºåˆ¶

æ¨ç†é€»è¾‘å®Œæ•´æ€§ï¼šâœ… é€šè¿‡
  âœ“ æ¨¡å‹åŠ è½½
  âœ“ é…ç½®è§£æ
  âœ“ æ¨ç†æµç¨‹
  âœ“ ç»“æœåå¤„ç†
  âœ“ é”™è¯¯å¤„ç†

================================================================================
âš¡ æ ¸å¿ƒæ”¹è¿›å›é¡¾
================================================================================

1. æ™ºèƒ½ç­”æ¡ˆæ˜ å°„ï¼ˆdataset.pyï¼‰
   - é‡‡ç”¨ebqaçš„char-to-tokenæ˜ å°„ç­–ç•¥
   - ä¼˜å…ˆé€‰"åŒ…å«"çš„tokenï¼Œå¤‡é€‰é€‰"é‚»è¿‘"çš„token
   - æ”¹è¿›äº†ç­”æ¡ˆè¾¹ç•Œå¤„ç†

2. è´Ÿæ ·æœ¬å¤„ç†ï¼ˆdataset.pyï¼‰
   - æ— ç­”æ¡ˆæ ·æœ¬æ ‡æ³¨ä¸º[0,0]è€Œä¸æ˜¯è·³è¿‡
   - è®­ç»ƒæ¨¡å‹å­¦ä¼šè¯†åˆ«"æ— ç­”æ¡ˆ"æƒ…å†µ
   - æå‡æ¨¡å‹é²æ£’æ€§

3. è®­ç»ƒå‚æ•°å‡çº§ï¼ˆebqa_config.jsonï¼‰
   - num_train_epochs: 2 â†’ 6
   - label_smoothing: 0.0 â†’ 0.08
   - use_weighted_sampler: false â†’ true
   - negative_downsample: 1.0 â†’ 0.4
   - short_field_weight: 1.0 â†’ 2.0

4. ä»£ç æ¸…ç†
   - åˆ é™¤äº†è¿‡æ—¶çš„è„šæœ¬å’Œé…ç½®
   - ç»Ÿä¸€äº†æ–‡ä»¶å‘½å
   - å®Œæ•´çš„æ–‡æ¡£è¯´æ˜

================================================================================
ğŸš€ å¿«é€Ÿå¯åŠ¨å‘½ä»¤
================================================================================

1. é¢„è®¡ç®—æ•°æ®:
   cd /mnt/windows/wy/ner-bert-crf
   python -m pre_struct.slide_window.precompute_dataset

2. å¼€å§‹è®­ç»ƒ:
   python -m pre_struct.slide_window.train_with_precomputed

3. æ¨ç†é¢„æµ‹:
   python -m pre_struct.slide_window.test_slide_window

4. æŒ‡å®šé…ç½®:
   EBQA_CONFIG_PATH=path/to/config.json python -m pre_struct.slide_window.train_with_precomputed

================================================================================
ğŸ“Š é¢„æœŸæ€§èƒ½
================================================================================

æ ·æœ¬æ•°é‡:
  åŸå§‹æŠ¥å‘Š: 283,535 æ¡
  é¢„è®¡ç®—æ ·æœ¬: ~40,000 ä¸ªï¼ˆåŒ…æ‹¬æ— ç­”æ¡ˆæ ·æœ¬ï¼‰

è®­ç»ƒæ—¶é—´:
  å• GPU (3090): 2-3 å°æ—¶
  4 GPU: 30-45 åˆ†é’Ÿ

æ¨ç†é€Ÿåº¦:
  å•æ ·æœ¬: ~0.5-1ç§’
  æ‰¹é‡: æ”¯æŒå¤šç§batch_sizeé…ç½®

================================================================================
ğŸ“ æ–‡æ¡£å¯¼èˆª
================================================================================

å¿«é€Ÿå…¥é—¨:
  â†’ README.md

è®­ç»ƒæŒ‡å—:
  â†’ README_è®­ç»ƒ.md

æ”¹è¿›å†…å®¹:
  â†’ æ”¹è¿›è¯´æ˜.md

æ¨ç†ä½¿ç”¨:
  â†’ æ¨ç†è¯´æ˜.md

é¡¹ç›®æ€»ä½“:
  â†’ é¡¹ç›®å®Œæ•´è¯´æ˜.md

================================================================================
âœ… é¡¹ç›®çŠ¶æ€æ€»ç»“
================================================================================

ä»£ç å®Œæ•´æ€§: âœ… 100%
  - æ‰€æœ‰æ ¸å¿ƒæ¨¡å—å·²å®Œæˆ
  - è¯­æ³•æ£€æŸ¥é€šè¿‡
  - é€»è¾‘å®Œæ•´

æ–‡æ¡£å®Œæ•´æ€§: âœ… 100%
  - é¡¹ç›®æ¦‚è§ˆæ–‡æ¡£
  - è®­ç»ƒæŒ‡å—
  - æ¨ç†è¯´æ˜
  - æ”¹è¿›è¯´æ˜

å¯ç”¨æ€§: âœ… 100%
  - å¯ç«‹å³è¿›è¡Œé¢„è®¡ç®—
  - å¯ç«‹å³è¿›è¡Œè®­ç»ƒ
  - å¯ç«‹å³è¿›è¡Œæ¨ç†

================================================================================

ğŸ‰ é¡¹ç›®å®Œå…¨å°±ç»ªï¼å¯ä»¥å¼€å§‹å·¥ä½œæµç¨‹ï¼

å·¥ä½œæµç¨‹å»ºè®®:
  1. python -m pre_struct.slide_window.precompute_dataset  (é¢„è®¡ç®—æ•°æ®)
  2. python -m pre_struct.slide_window.train_with_precomputed  (è®­ç»ƒæ¨¡å‹)
  3. python -m pre_struct.slide_window.test_slide_window  (æ¨ç†æµ‹è¯•)

================================================================================




====================================================================================================
æ–‡æ¡£ç»“æŸ
====================================================================================================

âœ… æ‰€æœ‰æ–‡æ¡£å†…å®¹å·²æˆåŠŸæ•´åˆ
ç”Ÿæˆæ–‡ä»¶ï¼šSLIDE_WINDOW_å®Œæ•´æ–‡æ¡£.md
